---
title: PBR 理论基础（二）
date: 2024-06-04 15:56:47
categories: 
  - [图形学]
tags:
  - 图形学
  - 游戏开发
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/06/04/nouFeJyYMt179RE.jpg
mathjax: true
description: 【长期更新】本笔记的主要内容有 XXXXXX。
---

> 本篇文章主要参考了毛星云的文章：《基于物理的渲染（PBR）白皮书》。本来有了毛星云的文章不打算自己再另写一篇关于 PBR 理论知识的文章了，但是后来还是决定做出一定的更改、补充和简化，方便自己理解。  
> 
> 之前的《Unity Shader入门精要》读书笔记（五）中也有对 PBR 的介绍，建议结合起来看。
> 
> 推荐一个谷歌的 Filament PBR 白皮书：https://google.github.io/filament/Filament.md.html#materialsystem/diffusebrdf 

# BRDF 模型各项
## Diffuse BRDF
Diffuse BRDF 主要包括以下几种方案：  
①Lambert [1760]  
②Oren Nayar [1994]  
③Simplified Oren-Nayar [2012]  
④Disney Diffuse [2012]（SIGGRAPH 2012 Physically-based shading at Disney）  
⑤Renormalized Disney Diffuse [2014]（SIGGRAPH 2014 Moving Frostbite to Physically Based Rendering）
⑥Gotanda Diffuse [2014]  
⑦PBR diffuse for GGX + Smith [2017]（GDC 2017 PBR Diffuse Lighting for GGX + Smith Microsurfaces）  
⑧MultiScattrering Diffuse BRDF [2018]（SIGGRAPH 2018 Material Advances in Call of Duty: WWII）  

我看了几篇知乎的文章，都比较推荐寒霜的 **Renormalized Disney Diffuse**：https://media.contentapi.ea.com/content/dam/eacom/frostbite/files/course-notes-moving-frostbite-to-pbr-v32.pdf ；https://www.ea.com/frostbite/news/moving-frostbite-to-pb

Renormalized Disney Diffuse 主要对 Disney(Burley) Diffuse 模型进行了改进，根据视角入射角对 Diffuse 进行补正来维持能量守恒，代码如下（没有乘 DiffuseColor 以及除以 π）：  

    float Fr_DisneyDiffuse (float NdotV, float NdotL, float LdotH, float linearRoughness)
    {
        float energyBias = lerp(0, 0.5 , linearRoughness);
        float energyFactor = lerp(1.0, 1.0 / 1.51 , linearRoughness);
        float fd90 = energyBias + 2.0 * LdotH * LdotH * linearRoughness;
        float3 f0 = float3(1.0f, 1.0f, 1.0f);
        float lightScatter = F_Schlick(f0, fd90, NdotL).r;
        float viewScatter = F_Schlick(f0, fd90, NdotV).r;

        return lightScatter * viewScatter * energyFactor ;
    }

    float3 F_Schlick (in float3 f0, in float f90, in float u)
    {
        return f0 + (f90 - f0) * pow (1.f - u , 5.f);
    }


## Specular BRDF
目前最主流的基于物理的镜面反射 BRDF 模型是基于微平面理论 microfacet theory 的 Microfacet Cook-Torrance BRDF。微平面理论即认为微面元的法线 m 等于 l 和 v 的一半，即半角向量 h（忘了就回去看《Unity Shader入门精要》读书笔记（五））。此 Specular BRDF 具有以下形式：

$$ f(l,v) = \cfrac {D(h)F(v,h)G(l,v,h)} {4(n \cdot l)(n \cdot v)} $$

$\,D(h)\,$：法线分布函数 Normal Distribution Function, NDF；$\,F(l, h)\,$: 菲涅尔方程 Fresnel Equation；$\,G(l, v, h)\,$: 几何函数 Geometry Function；分母 $\,4(n·l)(n·v)\,$：校正因子 Correction Factor，作为微观几何的局部空间和整个宏观表面的局部空间之间变换的微平面量的校正。

---

下图为 Specular BRDF 各项的不同模型方案（加粗为主流模型）：  

<div  align="center">  
<img src="https://s2.loli.net/2024/06/06/C5vgPZ1FUusJ8H2.png" width = "100%" height = "100%" alt="图15 - Specular BRDF 的不同模型"/>
</div>

菲涅尔项的 Schlick 的 Fresnel 近似式以及讲过很多次了，就不再提了，接下来详细介绍法线分布项以及几何项。

# Specular D
历史上主流的**法线分布函数 Normal Distribution Function，NDF**，按提出时间进行排序，可以总结为：  
①Berry [1923]  
②**Beckmann** [1963]  
③Phong [1973]  
④**Blinn-Phong** [1977]  
⑤ABC [1989]  
⑥**GGX** [2007] / **Trowbridge-Reitz** [1975]  
⑦Shifted Gamma Distribution，SGD [2012]  
⑧**Trowbridge-Reitz（GTR）**[2012]  
⑨Student’s T-Distribution , STD [2017]  
⑩Exponential Power Distribution , EPD [2017]  

法线分布函数已从传统的 Blinn-Phong 等分布，迁移到更接近真实材质外观表现，具备能量守恒，具有更宽尾部和更高峰值的 GGX 分布，而且在朝着多高光波瓣 multiple specular lobes 的方向发展。

传统光照模型中，一般只将几何体建模到中尺度的**法线贴图 Normal Map** 层面。虽说 Blinn-Phong 等分布也是基于微平面理论推导而来，但并没有配套粗糙度贴图 Roughness Map 为其提供亚像素级精度的细节，而且传统的 NDF 一般都没有经过归一化，不满足能量守恒，容易出现失真。

在基于物理的渲染工作流中，通过将**粗糙度贴图 Roughness Map** 与微平面归一化的法线分布函数结合使用，将需渲染的几何体的建模尺度细化到了微观尺度 Microscale 的亚像素层面。

## 法线分布函数介绍
**法线分布函数 Normal Distribution Function，NDF** 也称为**微表面分布函数 Microfacet Distribution Function**，记为 $\,D(m)\,$。一般我们用宏观表面的半矢量 h 来表示微观表面法线 m，因为仅 m = h 的表面点的朝向才会将光线 l 反射到视线 v 的方向，其他朝向的表面点对 BRDF 没有贡献（正负相互抵消）。所以 **D(m)** 也写作 **D(h)**。

$\,D(m)\,$ 并不是真的概率密度函数，而是表示所有朝向 h 的微平面的面积。更准确的说 D(m) 表示：**单位面积，单位立体角的微平面的面积**。定量的描述为：

$$ D(h) = \cfrac {d^2A_h} {dAd \omega_h } $$

其中，$\,dA\,$ 表示宏观表面上的一小块区域，$\,d^2A_h\,$ 表示微平面的面积。对上式积分：

$$ \int_{\Omega} D(h) (n \cdot h) d \omega_h = \cfrac {1} {dA} \int (n \cdot h) d^2A_h $$

$\,\Theta\,$ 符号表示在在整个球体上积分。而在以 n 为中心的半球上积分时，用 $\,\Omega\,$ 表示。$\,(n \cdot h)d^2A_h\,$ 表示朝向 h 的微表面在宏观表面上的投影面积，那么将宏观表面上所有方向的微表面的投影面积加起来，刚好会等于 dA，即：  

$$ \int (n \cdot h) d^2A_h = dA $$

其几何意义如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/06/17/2d6HZhRxveuXgbc.png" width = "40%" height = "40%" alt="图16 - D(h) 需要被归一化以满足微表面在宏观表面上的投影面积和宏观表面相等"/>
</div>

故为了保证物理准确性 D(h) 必须满足：

$$ \int_{\Omega} D(h) (n \cdot h) d \omega_h = 1 $$

---

另外 Walter 等人在论文 Microfacet Models for Refraction through Rough Surfaces 提出 D(h) 还需满足一个更强的限制条件：

$$ \int_{\Omega} D(h) (v \cdot h) d \omega_h = \cfrac {1} {dA} \int (v \cdot h) d^2A_h = n \cdot v $$

其中，v 是任意观察方向，当 v = n 时，该公式和上面公式是一样的，该式几何意义如下：

<div  align="center">  
<img src="https://s2.loli.net/2024/06/17/c8MtK2DRq1bSNeg.png" width = "50%" height = "50%" alt="图17 - 微观表面和宏观表面在垂直于任何视图方向 v 的平面上的投影是相等的"/>
</div>

$\,(v \cdot h) d^2 A_h = cos \theta d^2A\,$ 表示朝向 h 微表面在观察方向上的投影面积，其中有的面向 v 是正数，有的背朝 v 是负数；正负相加后，就刚好覆盖宏观表面上的单位区域 dA。

> 关于法线分布函数的更详细数学理解，不在这里阐述。有兴趣研究可以额外再去了解。其实作为使用者，而非学术研究者来说，对数学原理大致理解即可。


## 常见的法线分布函数
这里对其中在历史上使用和讨论较为广泛的几种法线分布函数，**Blinn-Phong**、**Beckmann**、**GGX (Trowbridge-Reitz)** 和 **GTR** 进行总结。

### Blinn-Phong 分布
Blinn-Phong 法线分布函数由 Blinn 推导出，作为（非基于物理的）Phong 着色模型的改进，以更好地拟合微平面 BRDF 的结构。Blinn-Phong 分布不具备形状不变性 shape-invariant。Blinn 在提出 Blinn-Phong 分布时没有指定归一化因子。加入归一化因子后的 Normalized Blinn-Phong 的公式如下：  

$$ D_p(m) = \cfrac {\alpha_p + 2} {2 \pi} (n \cdot m)^{\alpha_p} $$

其中 $\,\alpha^p\,$ 是 Blinn-Phong NDF 的**光滑度 smoothness** 参数。$\,\alpha^p\,$ 越大，表示微表面法线随机程度越小，表面越光滑；越小，微表面法线随机程度越大，表面更粗糙。对于非常光滑的曲面，值可以任意高（一个完美的镜面 $\,\alpha_p = \infty\,$），并且通过将 $\,\alpha^p\,$ 设置为 0 可以实现最大随机曲面（均匀 NDF），即兰伯特表面。

但这个 $\,\alpha^p\,$ 参数不便于艺术家操纵或直接绘制，因为它带来的视觉变化非常不均匀。这是因为 $\,\alpha^p\,$ 的变化与表面粗糙程度的变化并不呈线性关系。$\,\alpha^p\,$ 较小时，微小的变化会使表面粗糙程度剧烈变化；当 $\,\alpha^p\,$ 较大时，巨大的变化也不会使表面粗糙程度发生明显变化。出于这个原因，通常会定义**接口值 interface value**，艺术家调节这个接口值。例如：$\,\alpha^p=m^s\,$，其中 s 是 0 到 1 之间的艺术家接口值，m 是给定的电影或游戏中 $\,\alpha^p\,$ 的上限。这种映射被多款游戏使用，包括《使命召唤：黑色行动（Call of Duty: Black Ops）》，其中 m 被设置为值 8192。

在 UE4 中，则采用映射 $\,\alpha_p = 2\alpha^{-2} - 2\,$，那么得到的 Blinn-Phong 的形式为：  

$$ D_p(m) = \cfrac {1} {\pi \alpha^2} (n \cdot m) ^ {(\cfrac {2} {\alpha^2} - 2)} $$

UE4 中对 Blinn-Phong 的实现代码如下：  

    // [Blinn 1977, "Models of light reflection for computer synthesized pictures"]
    float D_Blinn( float a2, float NoH )
    {
        float n = 2 / a2 - 2;
        return (n+2) / (2*PI) * PhongShadingPow( NoH, n );    // 1 mad, 1 exp, 1 mul, 1 log
    }

---

上面的 Phong 分布只能表示**各项同性 isotropic** 材质表面的法线分布，也即围绕宏观法线 360 度的方向上，微表面分布相同，因此各项同性材质的 NDF 都是关于微观法线与宏观法线夹角 $\,\theta_h\,$ 的一元函数。

**各向异性 anisotropic** 材质在围绕宏观法线不同方向上，微表面分布不同。我们以宏观法线为 z 坐标，建立局部坐标系：  

<div  align="center">  
<img src="https://s2.loli.net/2024/06/17/Qbd42oTRjv5mqsX.png" width = "50%" height = "50%" alt="图18 - 天顶角与方位角"/>
</div>

各项异性材质的 NDF 可以描述成关于天顶角 $\,\theta_h\,$ 与方位角 $\,\phi_h\,$ 的二元函数。Ashikhmin 和 Shirley 对 Phong 模型稍加改造，提出了一个各向异性的 BRDF：An Anisotropic Phong BRDF Model。从中我们可以得到一个各项异性的 Phong 模型：

$$ D_{p(aniso)}(h) = \cfrac {\sqrt{(\alpha_x + 2)(\alpha_y + 2)}}{2 \pi} cos \theta_h^{\alpha_x cos^2 \phi_h + \alpha_y sin^2 \phi_h} $$

其中，$\,\alpha_x\,$, $\,\alpha_y\,$ 表示沿着 x 方向和 y 方向的光滑度，当 $\,\alpha_x = \alpha_y\,$ 时退化为各项同性的 Phong 分布。下图的 $\,\alpha_x = \alpha_y\,$ 对应 $\,n_u = n_v\,$。

<div  align="center">  
<img src="https://s2.loli.net/2024/06/17/8MmSdXsOwUGn59L.png" width = "80%" height = "80%" alt="图19 - 不同指数下金属球的效果"/>
</div>

### Beckmann 分布
Beckmann 分布是光学业界开发的第一批微平面模型中使用的法线分布，是一种基于高斯函数的 NDF。也是 Cook-Torrance BRDF 在提出时选择的 NDF。Beckmann NDF 具备形状不变性 shape-invariant。正确归一化后， Beckmann 分布具有以下形式：  

$$ D_b(h) = \cfrac {1} {\pi \alpha_b^2 (n \cdot h)^4 } e^{\cfrac {(n \cdot h)^2 -1}{(n \cdot h)^2 \alpha_b^2}} = \cfrac {e^{-tan^2\theta_h/\alpha_b^2}} {\pi \alpha_b^2 cos^4 \theta_h}$$

当 $\,tan \theta_h\,$ 越大时， 表示该微表面法线更偏离宏观法线。而参数 $\,\alpha_b\,$ 可以表示表面的**粗糙度 roughness**，其本质是 $\,tan \theta_h\,$ 的**均方差 root mean square，RMS**。类似于高斯分布的方差，而宏观法线方向类似于高斯分布的数学期望。当 $\,\alpha_b\,$ 越大时，“方差”越大，越多的微表面法线偏离宏观法线，表面越粗糙；当 $\,\alpha_b\,$ 越小时，“方差”越小，越多的微表面法线朝向宏观法线，表面越光滑。注意，$\,\alpha_b\,$ 参数的意义和 Blinn-Phong 的 $\,\alpha_p\,$ 的意义刚好相反，我们可以用一个等式将两个参数关联起来：$\,\alpha_p = 2\alpha_b^{-2} - 2\,$。

Beckmann 分布在 $\,\alpha_b < 0.5\,$ 时与 Phong 分布非常相似，也即在表示光滑表面时，Beckmann 和 Phong 效果几乎一样。Beckmann 分布的优势在于表示粗糙的表面，Phong 模型有一个最大的粗糙度，也即 $\,\alpha_p = 0\,$ 时的兰伯特表面，此时微表面法线均匀分布。而实际上兰伯特表面并不是最粗糙的表面，比如一些带有尖刺的纤维材质比兰伯特材质更粗糙，这时 Beckmamn 分布就派上用场了，当 $\,\alpha_b > 1\,$ 时，大量的微表面 h 和 n 接近垂直，可以表示超级粗糙 super rough 的材质，比如天鹅绒。

UE4 中对 Beckmann 分布的实现代码如下：  

    // [Beckmann 1963, "The scattering of electromagnetic waves from rough surfaces"]
    float D_Beckmann( float a2, float NoH )
    {
        float NoH2 = NoH * NoH;
        return exp( (NoH2 - 1) / (a2 * NoH2) ) / ( PI * a2 * NoH2 * NoH2 );
    }

Beckmann 的各项异性版本的形式如下：  

$$ D_b(aniso)(h) = \cfrac {e^{-tan^2 \theta_h(cos^2 \phi_h/ \alpha^2_x + sin^2 \phi_h / \alpha_y^2)}} {\pi \alpha_x \alpha_y cos^4 \theta_h} $$

当 $\,\alpha_x = \alpha_y\,$ 时，又退化成各向同性的 Beckmann 分布。

### GGX (Trowbridge-Reitz) 分布
GGX 即 Trowbridge-Reitz 分布，最初由 Trowbridge 和 Reitz [Trowbridge 1975] 推导出，在 Blinn 1977年的论文 [Blinn 1977] 中也有推荐此分布函数，但一直没有受到图形学界的太多关注。30 多年后，Trowbridge-Reitz 分布被 Walter 等人独立重新发现 [Walter 2007]，并将其命名为 GGX 分布。

GGX 分布的公式为：  

$$ D_{GGX}(h) = \cfrac {\alpha_{GGX}^2} {\pi((n \cdot h)^2(\alpha_{GGX}^2 - 1) + 1)^2} $$

其中参数 $\,\alpha_{GGX}\,$ 与 $\,\alpha_b\,$ 功能类似，随着 $\,\alpha_{GGX}\,$ 的增加，表面越粗糙。GGX 与 Beckmann 分布类似，也能表示超级粗糙的表面，但相比于 Beckmann 和 Phong，GGX 分布有一大特点，即在 h 和 n 夹角接近 90 度时（掠射角），函数值不为 0，这意味着 GGX 的高光有更长的“拖尾”。

GGX 分布具备形状不变性 shape-invariant，而与其对标的 GTR 等分布不具备形状不变性，这是 GGX 能普及的深层次原因。

在迪士尼原理着色模型 Disney principled shading model 中，Burley 推荐将粗糙度控制以 $\,α = roughness^2\,$ 暴露给用户，其中 roughness 是 0 到 1 之间的用户界面粗糙度参数值，以让分布以更线性的方式变化。这种方式实用性较好，不少使用 GGX 分布的引擎与游戏都采用了这种映射，如 UE4 和 Unity。

    // GGX / Trowbridge-Reitz
    // [Walter et al. 2007, "Microfacet models for refraction through rough surfaces"]
    float D_GGX( float a2, float NoH )
    {
        float d = ( NoH * a2 - NoH ) * NoH + 1; // 2 mad
        return a2 / ( PI*d*d );         // 4 mul, 1 rcp
    }

### Generalized-Trowbridge-Reitz（GTR）分布
Burley [Burley 2012] 根据对 Berry，GGX 等分布的观察，提出了广义的 **Generalized-Trowbridge-Reitz，GTR** 法线分布函数，其目标是允许更多地控制 NDF 的形状，特别是分布的尾部：

$$ D_{GTR}(h) = k \cfrac {1} {((n \cdot h)^2(\alpha^2_{GTR} - 1) + 1)^{\gamma}} $$

其中，k 是归一化常数，$\,\gamma\,$ 是控制 GTR 形状的参数。不同的 $\,\gamma\,$ 和 $\,\alpha_{GTR}\,$ 有不同的归一化参数：  

$$ k(\alpha_{GTR}, \gamma) = \cfrac {(\gamma - 1)(\alpha_{GTR}^2 - 1)} {\pi (1 - (\alpha_{GTR}^2)^{1 - \gamma})} $$

当 $\,\alpha_{GTR} = 1\,$ 和 $\,\gamma = 1\,$ 时有奇点，针对这两种情况，用替代的归一化常数：  

$$ k(\alpha_{GTR}, 1) = \frac {\alpha_{GTR}^2 - 1} {\pi ln(\alpha_{GTR}^2)}, k(1, \gamma) = \cfrac {1} {\pi} $$

> 注意 glsl 和 hlsl 中 log(x) 函数是 e 底的对数，即 ln(x)。

当 $\,\gamma = 1\,$，GTR 即 Berry 分布；当 $\,\gamma = 2\,$，GTR 即 GGX 分布。随着 $\,\gamma\,$ 的值减小，分布的尾部变得更长。而随着 $\,\gamma\,$ 值的增加，分布的尾部变得更短。

---

Burley 也给出了 GGX 分布（$\,\gamma = 2\,$）各项异性的版本：

$$ D_{GTR(aniso)}(h) = \cfrac {1} {\pi \alpha_x \alpha_y(sin^2 \theta_h(cos^2 \phi_h / \alpha_x^2 + sin^2 \phi_h / \alpha_y^2) + cos \theta_h^2)^2} $$

而任意 $\,\gamma\,$ 值的各项异性的 GTR，Burley 在文章中并没有给出，因此没有解析式。

下面是 Disney 对 GTR 的实现：

    float GTR1(float NdotH, float a)
    {
        if (a >= 1) return 1/PI;
        float a2 = a*a;
        float t = 1 + (a2-1)*NdotH*NdotH;
        return (a2-1) / (PI*log(a2)*t);
    }

    float GTR2(float NdotH, float a)
    {
        float a2 = a*a;
        float t = 1 + (a2-1)*NdotH*NdotH;
        return a2 / (PI * t*t);
    }

    float GTR2_aniso(float NdotH, float HdotX, float HdotY, float ax, float ay)
    {
        return 1 / (PI * ax*ay * sqr( sqr(HdotX/ax) + sqr(HdotY/ay) + NdotH*NdotH ));
    }

