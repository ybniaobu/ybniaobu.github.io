---
title: Custom Better PBR in Unity（一）
date: 2024-10-22 11:13:12
categories: 
  - [图形学]
  - [unity, pipeline]
tags:
  - 图形学
  - 游戏开发
  - unity
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/10/22/x6Xp3JjS4k5PO2W.gif
mathjax: true
description: 
---

> 本文章所阐述的 PBR Shader 仍然是在 URP 下的自定义 Shader，使用的仍然是最简单的前向渲染，为未来实现自己的自定义渲染管线 SRP 打下一定的基础。本篇文章创建时期，该 Shader 只包含最基础的 BRDF 标准模型，以后会增加 Anisotropic、Clearcoat、Cloth、Subsurface 等模型，我放在我的 Github 库里：https://github.com/ybniaobu/Unity_YPipeline ，最终在这个库中会实现自己的自定义渲染管线 YPipeline。
>  
> 该 PBR Shader 主要参考了著名的 LearnOpenGL 教程：https://learnopengl-cn.github.io/ 或 https://learnopengl.com/ ，以及谷歌的 Filament PBR 白皮书：https://google.github.io/filament/Filament.md.html#materialsystem/diffusebrdf 。

# Standard Shader 整体框架
顶点着色器不多说了，片元着色器整体框架如下：  
**1\. 初始部分**
$$\text{①声明 RenderingEquationContent 结构体}  \rightarrow \text{②声明并初始化材质及着色模型相关参数 InitializeStandardPBRParams} $$

**2\. IBL 部分**
$$ \text{③计算 RenderingEquationContent 里的 indirectLight (IBL) 项} $$

**3\. 主光源部分**
$$ \text{④声明并初始化主光源相关参数 InitializeMainLightParams} \rightarrow \text{⑤声明并初始化主光源 BRDF 计算所需参数 InitializeBRDFParams} $$ 

$$ \rightarrow \text{⑥计算 RenderingEquationContent 里的 directMainLight 项} $$

**3\. 其他光源部分**
$$ \text{⑦声明并初始化其他光源相关参数 InitializeAdditionalLightParams} \rightarrow \text{⑧声明并初始化其他光源 BRDF 计算所需参数 InitializeBRDFParams} $$ 

$$ \rightarrow \text{⑨计算 RenderingEquationContent 里的 directAdditionalLight 项} $$

每个步骤说明：  
**①**整个 Shader 的目的就是计算**渲染方程 The Rendering Equation**，即：L = Emission + Direct light diffuse term + Direct light specular term + Indirect light diffuse term + Indirect light specular term。由于游戏内需求的灯光不止一盏，故将 Direct light 分为 Main light 和 Additional light（暂时按 Unity 的 Main light 和 Additional light 的分法来，日后再修改）。故渲染方程可写为：L = Emission + Main Light + Additional Light + Indirect light (IBL)。

我把这些内容放置在了 `RenderingEquationLibrary.hlsl` 里的结构体 `RenderingEquationContent`：

    struct RenderingEquationContent
    {
        float3 directMainLight;
        float3 directAdditionalLight;
        float3 indirectLight;
    };

暂时没在该结构体里增加 Emission 项，因为自发光的物体的处理比较特殊，日后自定义渲染管线时专门处理，暂时不在 Standard Shader 里增加自发光功能。


