---
title: GAMES101-图形学入门公开课笔记（二）
date: 2024-04-23 21:53:41
categories: 
  - [图形学]
tags:
  - 图形学
  - 游戏开发
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/04/23/AnT1Gf8cdqDa69b.gif
mathjax: true
description: 本笔记的主要内容为 GAMES101 的第十三课到第二十二课，主要内容有xxxxxxxx。
---

> GAMES101 是一门现代计算机图形学入门课程，全名为**现代计算机图形学入门**，本课程将全面而系统地介绍现代计算机图形学的四大组成部分：①光栅化成像，②几何表示，③光的传播理论，以及④动画与模拟。由加州大学圣芭芭拉分校 UCSB 的闫令琪教授讲解，他的科研成果被直接应用于工业界，如影片《猩球崛起3：终极之战》与《狮子王2019》，以及与 NVIDIA 合作推动了实时光线追踪技术的产生。  
> 
> b 站视频 BV 号：BV1X7411F744
> 我觉得这门课更多起到一个抛砖引玉的作用，让我们对图形学的技术有个大概的了解。

# 第十三课 Ray Tracing
光栅化无法完美解决一些**全局 Global** 的效果，比如 Soft shadows 软阴影、Glossy reflection 光泽反射、Indirect illumination 间接光照等。

光线追踪的三个假设：  
①光沿直线传播；  
②光线不会发生碰撞，或者说是光线交错之间不会互相产生影响；  
③光线具有可逆性（光源传播至眼睛的光路可以反过来，即眼睛至光源）。

光线追踪首先做的是**光线投射 Ray Casting**。光线投射简单来讲，首先是从眼睛（摄像机）向裁切平面（屏幕）的每一个像素投射一条光线，即 **Eye Rays**。然后确定每条光线是否经过反射、折射等能够到达光源，此时称为 **Shadow Rays**，以确定是否产生阴影。之后就是对 intersection point 进行着色计算。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/jGbef9kUpouJgEZ.png" width = "75%" height = "75%" alt="图35 - Ray Casting - Generating Eye Rays"/>
</div>


## Whitted-Style Ray Tracing
**Recursive (Whitted-Style) Ray Tracing 递归光线追踪**，即如果光线发生反射或折射，则递归地跟踪反射或折射光线，直到光线衰减或达到最大递归深度，并对每个交点计算着色的值，如下图：

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/KGAJ4S3bw8Bijar.png" width = "75%" height = "75%" alt="图36 - Recursive Ray Tracing"/>
</div>

### Ray-Surface Intersection
核心问题就是计算交点。光线可以被定义为原点 origin 和一个方向向量，即：  

$$r(t) = o + td \,\,\,\,\,\,\,\,\,\, 0 \le t \le \infty $$

o 即原点，d 是归一化后的方向。

假设求光线和球的交点：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/E9tUNr7aGJVTFwv.png" width = "40%" height = "40%" alt="图37 - Ray Intersection With Sphere"/>
</div>

计算满足球函数和光线函数的交点，球函数为 $\,(p - c)^2 - R^2 = 0\,$，即计算交点的方程为 $\,(o + td - c)^2 - R^2 = 0\,$。

**隐式表达**的曲面 **Implicit Surface** 都可以用类似的方法计算。那么**显式表达**的表面如何处理，显式表达最多的就是网格，本质就是计算与三角形的交点。一个简单的方法就是计算每一个三角形与光线求交，但这样特别慢。该方法的计算如下：  

首先三角形与光线求交可以简化为两步：  
①首先光线跟三角形所在平面求交点；  
②然后判断交点是否在三角形内部。

接下来就是如何定义一个平面：平面可以定义为平面上的一个点 $\,p'\,$ 和平面的法线 N。所以平面方程（p 为平面上的点）可以写为 $\,(p - p') \cdot N = 0\,$。所以求交点就是解方程 $\,(o + td - p') \cdot N = 0\,$。这样就可以求出参数 t 了。接下来就是判断点是否在三角形内部了，也就是三次叉乘。

---

一个更快捷的计算三角形交点的方法是 **Möller Trumbore Algorithm**，它使用重心坐标表示光线：

$$ o + td = (1 - b_1 - b_2)P_0 + b_1P_1 + b_2P_2 $$

$\,1 - b_1 - b_2\,$、$\,b_1\,$、$\,b_2\,$ 就是重心坐标，它们的和是 1。$\,P_0\,$、$\,P_1\,$、$\,P_2\,$ 是三角形三个点。上述方程其实是一个三个式子三个未知数的线性方程组，这样就可以计算出来了，只要满足 $\,1 - b_1 - b_2\,$、$\,b_1\,$、$\,b_2\,$ 都大于 0 该点就在三角形内部。

### Accelerating Ray-Surface Intersection
之前的方法都是对每个三角形求个交点，这样非常慢，需要提高渲染效率。以下是一个加速的方法**包围体积 Bounding Volumes**：  

就是将复杂的物体用一个简单的形状包围，比如球体、长方体。如果光线没有击中包围盒，就没有击中物体。这个方法把包围盒 box 当作三对面（3 pairs of slabs）。而最常使用的是**轴对齐包围盒 Axis-Aligned Bounding Box AABB**，即长方形的每条边都是沿着坐标轴方向的，这样可以简化计算。

那么怎么判断光线和 box 相交，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/KFxe5iWRTYOd6sX.png" width = "80%" height = "80%" alt="图38 - Ray Intersection with Axis-Aligned Box"/>
</div>

对于二维的情况分别对两个对面求进入的时间 $\,t_{min}\,$ 和出去的时间 $\,t_{max}\,$。然后取其交集就是光线进入包围盒的区间，即 $\,max(t_{min}), min(t_{max})\,$。

对于三维来说，只有当光线进入了三个对面，光线才进入盒子；只要光线离开一个对面，光线才进入盒子，即对每个对面算出进入的时间 $\,t_{min}\,$ 和出去的时间 $\,t_{max}\,$。同理，对于三维盒子来说，$\,t_{enter} = max(t_{min})\,$，$\,t_{exit} = min(t_{max})\,$。当 $\,t_{enter} < t_{exit}\,$ 时，光线和盒子相交。$\,t_{exit} < 0\,$ 则盒子在光源背面。

更多内容在下节课讲。


# 第十四课 Ray Tracing II
## Using AABBs to accelerate ray tracing
接下来是如何利用 AABB 去加速光线追踪：  

### Uniform Grids
这个方法先对场景进行预处理，将场景划分为大量网格，记录哪一些格子与物体表面相交。只有当光线与格子相交，并且该格子与物体相交时，才对光线和物体求一次相交，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/jidwM7Xyh3gDqaB.png" width = "30%" height = "30%" alt="图39 - Ray-Scene Intersection"/>
</div>

这个方法适用于大量均匀分布的物体的场景。

### Spatial Partitions
这个方法对场景进行空间划分，密集的地方多分格子。常见的空间划分的算法如下：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/RXU4KN2iSH73Wgk.png" width = "70%" height = "70%" alt="图40 - Spatial Partitioning Examples"/>
</div>

这里主要讲 **KD-Tree**：按照 x、y、z 轴划分，分支节点记录当前节点沿着哪个轴划分，实际的物体只存储在叶子节点上。（下图中 1、2 节点也要分的，这里为了方便解释就没画上去）

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/K9OFD6PHnSk3Xe1.png" width = "70%" height = "70%" alt="图41 - KD-Tree Pre-Processing"/>
</div>

遍历 KD-Tree 的过程：先判断与分支节点所表示的包围盒是否有交点，若有交点，则判断与左右孩子节点是否有交点。若与孩子节点有交点且孩子节点是分支节点，则递归得往下进行；若与孩子节点有交点且孩子节点是叶子节点，则与该叶子节点所表示的包围盒内的所有物体求交。若与孩子节点所表示的包围盒无交点，则 return。

### Bounding Volume Hierarchy (BVH)
KD-Tree 针对的是包围盒，对包围盒进行划分，BVH 针对的是物体，即**物体划分 Object partition**，递归地将物体分成两堆，在对两堆物体分别求它们的包围盒（不同的 bounding box 是可能相交的），在叶子节点存储对象：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/MQnkRgFsD3H1LTf.png" width = "70%" height = "70%" alt="图42 - Bounding Volume Hierarchy"/>
</div>

遍历 BVH 和 KD-Tree 没本质区别。

## Radiometry
**辐射度量学 Radiometry** 提供了一个准确定义光照的一些物理属性的方法。之前的 Blinn-Phong 模型的光照只定义了一个光照强度 Intensity，不够精确。

辐射度量学精确定义了光的空间属性，比如：**辐射通量 Radiant flux**；**辐射强度 intensity**；**辐射照度 Irradiance**；**辐射亮度 Radiance**（翻译不好，最好不要用中文理解）。这样就可以在物理上准确地计算光照。

### Radiant Energy and Flux
①**辐射能量 Radiant energy** 定义如下：Radiant energy is the energy of electromagnetic radiation。辐射能量是电磁辐射的能量，用**焦耳 joules** 来计量：$\,Q[J = Joule]\,$。

②**辐射通量 Radiant flux(power)** 定义如下：Radiant flux (**power**) is the energy emitted, reflected, transmitted or received, per unit time。可以理解为功率，功率用**瓦特 Watt** 计量，对于光是用**流明 Lumen** 计量：$\,\Phi = \cfrac {dQ} {dt} [W = Watt] [lm = lumen]^*\,$。Flux 可理解为光子在单位时间内通过传感器的数量。为什么又称它为 Power，因为它就是灯泡的亮度，日常生活中都是单位时间接受到的能量。

### Other Important Light Measurements
<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/RLihBEXscC9vVe2.png" width = "70%" height = "70%" alt="图43 - Important Light Measurements"/>
</div>

①**辐射强度 intensity** 是光从光源辐射出来的能量。定义如下：The radiant (luminous) intensity is **the power per unit solid angle** emitted by a point light source。注意是单位立体角单位时间辐射出来的能量，即**单位立体角的 power**。公式如下（单位叫**坎德拉 candela**）：  

$$ I(w) = \cfrac {d \Phi} {d w} \,\,\,\,\,\,\,\,\,\, [\cfrac {W} {sr}] [\cfrac {lm} {sr} = cd = candela]$$

立体角可以类比二维中一个圆的弧度的一个三维衍生。弧度是弧长除以半径，**立体角是球中某个区域的面积与球的半径平方之比**：$\,\Omega = \cfrac {A} {r^2}\,$，这样整个球面就是 $\,\cfrac {4 \pi r^2} {r^2}\,$，即 $\,4 \pi\,$ 立体角（单位为**球面度 steradians**）。对于一个圆是 $\,2 \pi\,$ 弧度。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/anuSAejGEP9lrDJ.png" width = "70%" height = "70%" alt="图44 - Differential Solid Angles"/>
</div>

对于整个球来说，对球面做一个积分，就应该得到整个球的立体角：

$$ \Omega = \int_{s^2} dw = \int_0^{2 \pi} \int_0^{\pi} sin \theta d \theta d \phi = 4 \pi$$

对于各向同性的点光源来说，$\,I = \cfrac {\Phi} {4 \pi}\,$。反过来讲，也就是对单位立体角积分起来可以得到 power：$\,\Phi = \int_{s^2} I dw = 4\pi I\,$。

②**辐射照度 Irradiance** 是物体表面接受到的能量。定义如下：The irradiance is **the power per unit area** incident(入射) on a surface point。注意是单位接受面积接受到的单位时间辐射出来的能量，即**单位接受面积的 power**。公式如下（单位叫**勒克斯 lux**）：  

$$ E(x) = \cfrac {d \Phi (x)} {dA} \,\,\,\,\,\,\,\,\,\, [\cfrac {W} {m^2}] [\cfrac {lm} {m^2} = lux] $$

Irradiance 定义的是垂直方向上的光，故符合 Lambert’s Cosine Law，即 Irradiance 与光线与法线方向的夹角的余弦值成正比：$\,E = \cfrac {\Phi} {A} cos \theta\,$。

对于光线衰减的正确理解：只有 irradiance 在衰减，intensity 不会衰减，因为在远的那个位置立体角没有变化（即随着距离的拉远，立体角没变，单位面积变大），如下图：

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/cAUrBFt5i31umYv.png" width = "70%" height = "70%" alt="图45 - Irradiance Falloff"/>
</div>

③**辐射亮度 Radiance** 是光线传播过程的能量。Radiance is the fundamental field quantity that describes the distribution of light in an environment，Radiance is the quantity associated with a ray。因为它和 ray 密切相关，故和光线追踪密切相关。它的物理定义如下：The radiance (**luminance**) is the power emitted, reflected, transmitted or received by a surface, **per unit solid angle, per projected unit area**。也就是 **Intensity 和 Irradiance 的合体**，即 randiance 是 **irradiance per solid angle** 或者 **intensity per projected unit area**。公式如下（单位叫**尼特 nit**）：

$$ L(p,w) = \cfrac {d^2 \Phi(p, w)} {dw dAcos \theta} \,\,\,\,\,\,\,\,\,\, [\cfrac {W} {sr\,m^2}] [\cfrac {cd} {m^2} = \cfrac {lm} {sr\,m^2} = nit] $$

这样就产生了两种理解：  
&emsp;&emsp; - **入射辐射亮度 Incident Radiance**：the irradiance per unit solid angle arriving at the surface。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/Hk1weQnGPjC9ZF5.png" width = "50%" height = "50%" alt="图46 - Incident Radiance"/>
</div>

&emsp;&emsp; - **出射辐射亮度 Exiting Radiance**：the intensity per unit projected area leaving the surface。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/9XFYqEWfv8t4w3A.png" width = "50%" height = "50%" alt="图47 - Exiting Radiance"/>
</div>

---

Irradiance vs. Radiance：  
①**Irradiance**: total power received by area $\,dA\,$，也就是对 Radiance 所有方向上积分，也就是下图的式子 2；  
②**Radiance**：power received by area $\,dA\,$ from “direction” $\,dw\,$。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/MLmEV5AKByefoTj.png" width = "50%" height = "50%" alt="图48 - Irradiance vs. Radiance"/>
</div>


# 第十五课 Ray Tracing III
## Bidirectional Reflectance Distribution Function (BRDF)
**BRDF 双向反射分布函数**，它描述了对于给定的入射方向，有多少光反射到了给定的反射方向。

首先反射可以这样描述：Radiance from direction $\,ω_i\,$ turns into the power E that $\,dA\,$ receives，Then power E will become the radiance to any other direction ω。简单来说，就是光入射到 A 后，被吸收了部分能量，然后出射出去。如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/wPjcLZthN3XaqTu.png" width = "60%" height = "60%" alt="图49 - Reflection at a Point"/>
</div>

而 BRDF 描述的就是出射和入射的比例：  

$$ f_r(w_i \rightarrow w_r) = \cfrac {dL_r(w_r)} {dE_i(w_i)} = \cfrac {dL_r(w_r)} {L_i(w_i) cos \theta_i dw_i} \,\,\, [ \cfrac {1} {sr} ] $$

接下来就是对于每一个入射方向加起来（做积分），这样就可以得到某一出射方向上的**反射方程 The Reflection Equation**，即定义任意着色点在各个入射光照的输入下对一个观测方向（即出射方向）的贡献：  

$$ L_r(p, w_r) = \int_{H^2} f_r(p, w_i \rightarrow w_r ) L_i(p, w_i) cos \theta_i d w_i $$

<div  align="center">  
<img src="https://s2.loli.net/2024/04/26/2DcMBWPRxA1ldZ3.png" width = "60%" height = "60%" alt="图50 - The Reflection Equation"/>
</div>

但这样有个问题是一个面接受到的光，不仅仅来自光源，还来自别的物体反射的光。这个问题先放着。

---

接下来是**渲染方程 The Rendering Equation**，之前没有考虑物体发光的情况，把 **Emission term** 加入得到渲染方程：  

$$ L_r(p, w_r) = L_e(p, w_r) + \int_{\Omega +} L_i(p,w_i) f_r(p,w_i,w_r)(n \cdot w_i)dw_i $$

## Understanding the rendering equation
上面的渲染方程的 $\,L_r(p, w_r)\,$ 就是 Reflected Light；$\,L_e(p, w_r)\,$ 是 Emission term；$\,\int_{\Omega +} L_i(p,w_i)dw_i\,$ 是所有 Incident Light 的汇总；$\,f_r(p,w_i,w_r)\,$ 是 BRDF；$\,n \cdot w_i\,$ 是入射角的余弦值。

将渲染方程写简单点如下：  

$$ l(u) = e(u) + \int l(v) K(u,v) dv $$

再简写就是：$\, L = E + KL \,$，这里假设的是把场景中所有的光当做 L，那么所有的光 L 应该等于所有发出的光 E 假设所有反射的光 KL。对方程处理后可得：  

$$ L = E + KL \rightarrow (I - K)L = E \rightarrow L = (I - K)^{-1}E $$

展开后可得：  

$$ L = (I + K + K^2 + K^3 + \cdots )E $$
$$ L = E + KE + K^2E + K^3E + \cdots $$

E 就是所有灯发出的光 Emission directly From light sources；KE 就是弹射一次的光，即直接光 Direct Illumination on surfaces；$\,K^2E\,$ 就是弹射第两次的光，或称弹射第一次的间接光 One bounce indirect Illumination。$\,K^3E\,$ 就是弹射第三次的光，或称弹射第二次的间接光 Two bounce indirect Illumination。

这样就可以把光分为**自发光 Emission**、**直接光 Direct Illumination** 和**间接光 Indirect Illumination**。所有的加起来称为**全局光照 Global Illumination**。


# 第十六课 Ray Tracing IV
## Probabilities Review
**概率分布函数 Probability Distribution Function (PDF)**：$\,X \sim p(x)\,$，它描述的是连续的变量 X 的概率密度 p(x) 函数。

概率密度 $\,p(x) \geq 0\,$（函数积分或面积为概率），并且整个 p(x) 的积分为 1（所有值的概率合计为 1）：$\,\int p(x) dx = 1\,$

那么对于期望值就是所有值 X 乘上所有值的概率密度的面积，即 $\,E(X) = \int x p(x) dx\,$

若随机变量 X 满足函数 Y，即 $\,Y = f(X)\,$。那么函数 Y 的期望就是 $\,E(Y) = E(f(X)) = \int f(x) p(x) dx\,$

## Monte Carlo Path Tracing
### Monte Carlo Integration
**蒙特卡洛积分**就是在积分域中不断采样，根据 x 采样出的 y 值计算出长方形的面积，然后通过不断的采样无限多的点，对所有的长方形面积求平均，从而得到定积分的值。

若以均匀的概率对函数的定积分 $\,\int_a^b f(x) dx\,$ 进行采样，那么这个基本的蒙特卡洛估计的函数如下：  

$$ F_N = \cfrac {b - a} {N} \sum_{i = 1}^N f(X_i) $$

b - a 就是长方形的宽，即对高求和，乘上宽得到面积之和后平均。

若以更通用的角度来说，以概率密度函数的分布进行采样，则蒙特卡洛积分可以写成：  

$$ \int f(x) dx = \cfrac {1} {N} \sum_{i=1}^N \cfrac {f(X_i)} {p(X_i)} \,\,\,\,\,\,\,\,\,\, X_i \sim p(x) $$

之所以是除以概率密度，可以理解为需要剔除采样时的不均匀的影响。

### Path Tracing
区分 **Path Tracing 路径追踪** 和之前的 **Ray tracing 光线追踪**（广义上来说路径追踪也可以称为光线追踪）。之前的 **Whitted-Style Ray Tracing** 存在一些问题：  
①只能处理完全镜面反射 Specular/Mirror reflection，遇到 Glossy Reflection（反射方向不是完全镜面反射的反射方向，比如一些有点磨砂的金属材质）会出现问题。  
②它假设光线打到漫反射物体就停止弹射，无法模拟一部分间接光照。

而 Path Tracing 则尝试使用蒙特卡洛积分来解渲染方程，因为渲染方程是在半球上的积分。

### Monte Carlo Solution
先简单考虑一个像素点的直接光照部分，我们就可以把反射方程用蒙特卡洛积分写成：  

$$ \begin{align*} L_o(p, w_o) &= \int_{\Omega +} L_i(p, w_i) f_r(p,w_i,w_o)(n \cdot w_i) dw_i \\ &\approx \cfrac {1} {N} \sum_{i = 1}^N \cfrac {L_i(p, w_i) f_r(p,w_i,w_o)(n \cdot w_i)} {p(w_i)}\end{align*} $$

若对半球进行均匀采样，则 $\,p(w_i) = 1/2 \pi\,$ (半球的立体角是 2π，面积为 1，所以 1/2π）。

所以对于每个着色点，对随机采样的入射方向先验证是否能达到光源，若能则进行求和。

同时也可以引入间接光照，入射方向若先打到一个物体再到光源，我们可以把该物体的直接光照（就是反射出来的 radiance）算出来，当作着色点的入射的 radiance，也就是该物体的反射方向或观察方向是 $\,-w_i\,$。所以要支持间接光照，即若光线先打到一个物体，计算出该物体的直接光照，作为要求的着色点的入射的 $\,L_i(p, w_i)\,$，进行求和。如此递归地计算就可以模拟全局光照了。

---

但这样做也会有缺陷：如此递归地计算会出现指数爆炸，即采样的光线数为 N，光线弹射次数为 bounces，则最终眼睛里有 $\,N^{bounces}\,$ 条光线。解决方法就是，每次只随机采样一个方向的光线，这样 N = 1，就没有指数爆炸了。如果采用 N = 1 （每个点采样一条光线）的方式就叫做 path tracing，N 不等于 1 的时候叫 Distributed Ray Tracing。

不过这样也会带来问题，过于 noisy。因为蒙特卡洛实际上是对积分进行近似，采样越多近似越精准，采样一条路径结果肯定有失偏颇。解决方法是重复多次寻找多条路径，再将多条路径的结果求平均，即对同一个像素追踪多条路径做平均。

还有一个问题是我们要对递归设置一个出口，如果设置一个递归栈的深度，比如说我们限定它弹射最多 20 次，但这样一定会造成一定的能量损失。此时可以使用一个叫 **Russian Roulette 俄罗斯轮盘** 的方法，引入一个概率 p，以一定的概率 p 往一个方向射出一条光线，以 (1 - p) 的概率不打出光线，最后的返回值除以 p。这种方式得到的期望是真实的。

此时基本上就可以得到一个正确的路径追踪了，虽然仍然效率不高。因为在每次计算直接光照的时候，任选一个方向采样，但很少会的光线可以打到光源，尤其当光源较小的时候，这种现象越明显，大量采样的光线都被浪费了。我们希望能直接在光源上采样，因此我们将采样的对象由角度变为光源(的面积)，这样所有采样的光线都一定会击中光源(如果中间没有别的物体)，没有光线再会被浪费了。此时需要对渲染方程进行换元，对 dw 进行换元，dw 是光源面积 dA 在半球面上的投影，而 dw 和 dA 存在函数关系，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/30/FRtDuKNkGzmvcAY.png" width = "60%" height = "60%" alt="图51 - Sampling the Light"/>
</div>

则渲染方程可以换元为：

$$ \begin{align*} L_o(x, w_o) &= \int_{\Omega +} L_i(x, w_i) f_r(x,w_i,w_o)(n \cdot w_i) dw_i \\ &= \int_A L_i(x, w_i) f_r(x,w_i,w_o) \cfrac {cos \theta cos \theta'} {|x' - x|^2}dA \end{align*} $$

那么我们可以区分直接光照和间接光照，对于直接光照，采用这种方法计算（不需要进行俄罗斯轮盘赌），对于间接光照，采用之前的方式进行计算（需要进行俄罗斯轮盘赌）。计算直接光照时，还需要判断光源和着色点之间是否有物体遮挡，发射一条检测光线就可以判断。

路径追踪的效果几乎是百分百的 PHOTO-REALISTIC。


# 第十七课 Materials and Appearances
## Material
在图形学中是给不同的物体指定不同的材质，即指定它们如何和光线产生作用。在渲染方程中，BRDF决定了光如何被反射，所以我们就可以认为 BRDF 描述了物体的材质。

### Diffuse / Lambertian Material (BRDF)
漫反射材质：光线均匀地反射到各个不同方向上。假设入射光线也都是均匀的，且这个着色点能量守恒，该点不发光也不吸收光，即入射光和出射光的 radiance 相同。此时可以认为入射光 $\,L_i\,$ 是个常数，BRDF（$\,f_r\,$) 也是常数，将常数提出来，此时渲染方程如下：  

$$ \begin{align*} L_o(w_o) &= \int_{H^2} f_r L_i(w_i) cos \theta_i dw_i \\ &= f_r L_i \int_{H^2} cos\theta_i d w_i \\ &= \pi f_r L_i\end{align*} $$

因为 $\,L_0\,$ 等于 $\,L_i\,$，也就是 BRDF 等于 $\,1/\pi\,$ 时，是完全不吸收能量的漫反射材质 BRDF。同时我们可以定义反射率 albedo，它是单通道的一个数，也可以是 RGB，也可以是光谱。它在 0－1 之间，如此一来我们就能引入不同颜色的 BRDF，值就是 $\,Albedo/\pi\,$，即最终的漫反射的 BRDF。

### Glossy material (BRDF)
**Glossy 光泽材质**，是一种不完全的镜面反射（反射会出现些许的散开），类似于抛光金属。完全的反射以及折射材质 reflective / refractive material 就是水或玻璃（BSDF = BRDF+ BTDF）。

### Snell’s Law
**斯涅尔定律 Snell’s Law** 即**折射定律**。即 $\,\eta_i sin \theta_i = \eta_t sin \theta_t\,$。$\,\eta_i\,$、$\,\eta_t\,$ 为入射前材质和入射后材质的折射率，即 **Index of refraction IOR**。$\,\theta_i\,$、$\,\theta_t\,$ 是入射角和折射角。根据上述公式，可以算出折射角：

$$ cos \theta_t = \sqrt {1 - (\cfrac {\eta_i} {\eta_t})^2( 1 - cos^2 \theta_i)} $$

当 $\,\eta_i / \eta_t > 1\,$ 时，也就是入射前折射率大于入射后折射率时，就有可能出现全反射现象。

### Fresnel Reflection
**菲涅耳反射 Fresnel Reflection** 描述的现象就是：随着掠射角的增大，反射的程度变大。

绝缘体的菲涅耳项如下（S、P polarization 是光的极化现象）：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/30/ujFdS5tUc3grD4P.png" width = "50%" height = "50%" alt="图52 - Dielectric Fresnel Term"/>
</div>

可以看到和物体表面越平行，反射程度越大。但金属（导体）无论掠射角，反射程度都很大，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/30/qm2sUlTvP5WoaGK.png" width = "50%" height = "50%" alt="图53 - Conductor Fresnel Term"/>
</div>

精确的菲涅耳项是要考虑极化的，但是一般渲染不考虑，近似方法就是之前文章提到过的  Schlick’s approximation，详见《Unity Shader入门精要》读书笔记。

## Microfacet Material
### Microfacet Theory
微表面理论，假设在远处看物品表面平整且粗糙，从近处看凹凸不平且镜面。每个微表面都有自己的法线。微表面法向量分布与整体几乎一致即 Glossy 材质，微表面法向量分布向各个不同方向上散开即 Diffuse 材质。

### Microfacet BRDF
$$ f(i,o) = \cfrac {F(i,h) G(i,o,h) D(h)} {4(n \cdot i)(n \cdot o)} $$

F：菲涅尔项；G：几何函数，也称为阴影遮挡函数；D：法线分布函数。之前入门精要有讲过，想再深入了解，还是得看毛星云大佬的文章。

微表面模型有很多种模型，都是基于微表面理论的，比如 **Cook-Torrance BRDF**、**Ward BRDF**。

### Isotropic / Anisotropic Materials
**各向同性 Isotropic** 认为微表面法线的方向性很弱；**各向异性 Anisotropic** 认为微表面法线分布有明确的方向性。

## Properties of BRDFs
BRDF 的性质总结：  
①非负性 Non-negativity：

$$ f_r(w_i \rightarrow w_r) \ge 0 $$

②线性 Linearity：BRDF 可以线性地加在一起，或者分拆成很多部分。  
③可逆性 Reciprocity principle：

$$ f_r(w_r \rightarrow w_i) = f_r(w_i \rightarrow w_r) $$

④能量守恒 Energy conservation：  

$$ \forall w_r \int_{H^2} f_r(w_i \rightarrow w_r) cos \theta_i d w_i \le 1 $$


# 第十八课 Advanced Topics in Rendering
