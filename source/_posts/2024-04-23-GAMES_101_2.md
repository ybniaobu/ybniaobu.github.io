---
title: GAMES101-图形学入门公开课笔记（二）
date: 2024-04-23 21:53:41
categories: 
  - [图形学]
tags:
  - 图形学
  - 游戏开发
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/04/23/AnT1Gf8cdqDa69b.gif
mathjax: true
description: 本笔记的主要内容为 GAMES101 的第十三课到第二十二课，主要内容有xxxxxxxx。
---

> GAMES101 是一门现代计算机图形学入门课程，全名为**现代计算机图形学入门**，本课程将全面而系统地介绍现代计算机图形学的四大组成部分：①光栅化成像，②几何表示，③光的传播理论，以及④动画与模拟。由加州大学圣芭芭拉分校 UCSB 的闫令琪教授讲解，他的科研成果被直接应用于工业界，如影片《猩球崛起3：终极之战》与《狮子王2019》，以及与 NVIDIA 合作推动了实时光线追踪技术的产生。  
> 
> b 站视频 BV 号：BV1X7411F744
> 我觉得这门课更多起到一个抛砖引玉的作用，让我们对图形学的技术有个大概的了解。

# 第十三课 Ray Tracing
光栅化无法完美解决一些**全局 Global** 的效果，比如 Soft shadows 软阴影、Glossy reflection 光泽反射、Indirect illumination 间接光照等。

光线追踪的三个假设：  
①光沿直线传播；  
②光线不会发生碰撞，或者说是光线交错之间不会互相产生影响；  
③光线具有可逆性（光源传播至眼睛的光路可以反过来，即眼睛至光源）。

光线追踪首先做的是**光线投射 Ray Casting**。光线投射简单来讲，首先是从眼睛（摄像机）向裁切平面（屏幕）的每一个像素投射一条光线，即 **Eye Rays**。然后确定每条光线是否经过反射、折射等能够到达光源，此时称为 **Shadow Rays**，以确定是否产生阴影。之后就是对 intersection point 进行着色计算。

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/jGbef9kUpouJgEZ.png" width = "75%" height = "75%" alt="图35 - Ray Casting - Generating Eye Rays"/>
</div>


## Whitted-Style Ray Tracing
**Recursive (Whitted-Style) Ray Tracing 递归光线追踪**，即如果光线发生反射或折射，则递归地跟踪反射或折射光线，直到光线衰减或达到最大递归深度，并对每个交点计算着色的值，如下图：

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/KGAJ4S3bw8Bijar.png" width = "75%" height = "75%" alt="图36 - Recursive Ray Tracing"/>
</div>

### Ray-Surface Intersection
核心问题就是计算交点。光线可以被定义为原点 origin 和一个方向向量，即：  

$$r(t) = o + td \,\,\,\,\,\,\,\,\,\, 0 \le t \le \infty $$

o 即原点，d 是归一化后的方向。

假设求光线和球的交点：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/E9tUNr7aGJVTFwv.png" width = "40%" height = "40%" alt="图37 - Ray Intersection With Sphere"/>
</div>

计算满足球函数和光线函数的交点，球函数为 $\,(p - c)^2 - R^2 = 0\,$，即计算交点的方程为 $\,(o + td - c)^2 - R^2 = 0\,$。

**隐式表达**的曲面 **Implicit Surface** 都可以用类似的方法计算。那么**显式表达**的表面如何处理，显式表达最多的就是网格，本质就是计算与三角形的交点。一个简单的方法就是计算每一个三角形与光线求交，但这样特别慢。该方法的计算如下：  

首先三角形与光线求交可以简化为两步：  
①首先光线跟三角形所在平面求交点；  
②然后判断交点是否在三角形内部。

接下来就是如何定义一个平面：平面可以定义为平面上的一个点 $\,p'\,$ 和平面的法线 N。所以平面方程（p 为平面上的点）可以写为 $\,(p - p') \cdot N = 0\,$。所以求交点就是解方程 $\,(o + td - p') \cdot N = 0\,$。这样就可以求出参数 t 了。接下来就是判断点是否在三角形内部了，也就是三次叉乘。

---

一个更快捷的计算三角形交点的方法是 **Möller Trumbore Algorithm**，它使用重心坐标表示光线：

$$ o + td = (1 - b_1 - b_2)P_0 + b_1P_1 + b_2P_2 $$

$\,1 - b_1 - b_2\,$、$\,b_1\,$、$\,b_2\,$ 就是重心坐标，它们的和是 1。$\,P_0\,$、$\,P_1\,$、$\,P_2\,$ 是三角形三个点。上述方程其实是一个三个式子三个未知数的线性方程组，这样就可以计算出来了，只要满足 $\,1 - b_1 - b_2\,$、$\,b_1\,$、$\,b_2\,$ 都大于 0 该点就在三角形内部。

### Accelerating Ray-Surface Intersection
之前的方法都是对每个三角形求个交点，这样非常慢，需要提高渲染效率。以下是一个加速的方法**包围体积 Bounding Volumes**：  

就是将复杂的物体用一个简单的形状包围，比如球体、长方体。如果光线没有击中包围盒，就没有击中物体。这个方法把包围盒 box 当作三对面（3 pairs of slabs）。而最常使用的是**轴对齐包围盒 Axis-Aligned Bounding Box AABB**，即长方形的每条边都是沿着坐标轴方向的，这样可以简化计算。

那么怎么判断光线和 box 相交，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/KFxe5iWRTYOd6sX.png" width = "80%" height = "80%" alt="图38 - Ray Intersection with Axis-Aligned Box"/>
</div>

对于二维的情况分别对两个对面求进入的时间 $\,t_{min}\,$ 和出去的时间 $\,t_{max}\,$。然后取其交集就是光线进入包围盒的区间，即 $\,max(t_{min}), min(t_{max})\,$。

对于三维来说，只有当光线进入了三个对面，光线才进入盒子；只要光线离开一个对面，光线才进入盒子，即对每个对面算出进入的时间 $\,t_{min}\,$ 和出去的时间 $\,t_{max}\,$。同理，对于三维盒子来说，$\,t_{enter} = max(t_{min})\,$，$\,t_{exit} = min(t_{max})\,$。当 $\,t_{enter} < t_{exit}\,$ 时，光线和盒子相交。$\,t_{exit} < 0\,$ 则盒子在光源背面。

更多内容在下节课讲。


# 第十四课 Ray Tracing II
## Using AABBs to accelerate ray tracing
接下来是如何利用 AABB 去加速光线追踪：  

### Uniform Grids
这个方法先对场景进行预处理，将场景划分为大量网格，记录哪一些格子与物体表面相交。只有当光线与格子相交，并且该格子与物体相交时，才对光线和物体求一次相交，如下图：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/jidwM7Xyh3gDqaB.png" width = "30%" height = "30%" alt="图39 - Ray-Scene Intersection"/>
</div>

这个方法适用于大量均匀分布的物体的场景。

### Spatial Partitions
这个方法对场景进行空间划分，密集的地方多分格子。常见的空间划分的算法如下：  

<div  align="center">  
<img src="https://s2.loli.net/2024/04/24/RXU4KN2iSH73Wgk.png" width = "70%" height = "70%" alt="图40 - Spatial Partitioning Examples"/>
</div>

