---
title: PBR 理论基础（一）
date: 2024-05-21 14:20:48
categories: 
  - [图形学]
tags:
  - 图形学
  - 游戏开发
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/05/21/6QnAbYhwJX4Bavl.png
mathjax: true
description: 本笔记的主要内容有 XXXXXXXXX。
---

> 本篇文章主要参考了毛星云的文章：《基于物理的渲染（PBR）白皮书》。本来有了毛星云的文章不打算自己再另写一篇关于 PBR 理论知识的文章了，但是后来还是决定以自己的语言复述一遍并做出一定的简化，方便自己理解。  
> 
> 之前的《Unity Shader入门精要》读书笔记（五）中也有对 PBR 的介绍，对重复的较熟悉的内容不再详细复述。

# PBR 核心理论基础
**基于物理的渲染 Physically Based Rendering，PBR** 是指使用基于物理原理和微平面理论建模的着色/光照模型，以及使用从现实中测量的表面参数来准确表示真实世界材质的渲染理念。可以由三部分组成基于物理的材质 Material，基于物理的光照 Lighting 以及基于物理适配的摄像机 Camera。

PBR 的理论基础主要包括以下内容： 

## 光学相关
### 人眼视觉  
人眼接收到的是物体反射和散射得到的颜色，那些不能被物体吸收 Absorb 的颜色，即被反射或散射到我们人眼中的可见光波长代表的颜色，就是我们能够感知到的物体的颜色。

被反射或散射的光线进入人眼后，首先穿过**角膜 cornea**， 然后进入**瞳孔 pupil**。 随后，光被**晶状体 lens** 折射并撞击**视网膜 retina** 中的两种类型的**感光细胞 photoreceptors**，包括**视锥细胞 cones** 和**视杆细胞 rods**。这些感光细胞从视野范围内吸收光子，然后经一系列特殊复杂的生物化学通路，根据光线中的不同的波长产生不同颜色的视觉信号，波长越高的光偏红，波长越低的光偏蓝。视觉信号通过视神经 optical nerve 传递到视觉皮层 visual cortex，而视觉皮层作为处理视觉信号的大脑区域，用于产生最终的感知图像。上述负责整体人类视觉功能的完整系统被称为**人类视觉系统 Human Visual System，HVS**。不同感光细胞对不同波长的感知敏感度不同。只有可见光才能被人眼感知并处理，而可见光仅覆盖完整电磁波谱在 400 nm 和 700 nm之间非常有限的光谱区间。

### 物理光学 Physical Optics
**波动光学 Wave Optics** 又称**物理光学 Physical Optics**。在波动光学中，光被建模为一种**电磁横波 Transverse Wave**，即电磁波伴随的电场方向、磁场方向和传播方向三者互相垂直。

<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/8hKv6VDsdZjuGyn.png" width = "60%" height = "60%" alt="图1 - 一个简单的光波。它既是单色的（具有单一波长 λ ）又是线性极化的（电场和磁场各自沿单向振荡）"/>
</div>

光波的磁场和电场的振荡相互耦合，且磁场矢量和电场矢量相互垂直，两者长度之比固定，该比率等于**相速度 Phase Velocity**。

而光在传播到两种不同介质交界处时，原始光波和新的光波的相速度 Phase Velocity 的比率定义了介质的光学性质，就是**折射率 Index of Refraction，IOR**，由字母 n 表示。

### 复折射率 complex index of refraction
除了代表光的相速度的实部 $\,n\,$ 之外，还用希腊字母 $\,\kappa\,$（kappa）表示介质将光能转为为其他形式能量的吸收性。$\,n\,$ 和 $\,\kappa\,$ 通常都随波长而变化，两者组合成复数 $\,n + i\kappa\,$，称为**复折射率 complex index of refraction**。

即折射率 IOR 是一个复数，其分为实部和虚部两部分：  
&emsp;&emsp; - 折射率的**实部 real part** 度量了物质如何影响光速，即相对于光在真空中传播速度减慢的度量。  
&emsp;&emsp; - 折射率的**虚部 imaginary part** 确定了光在传播时是否被吸收，转换成其他形式的能量，通常是热能。非吸收性介质虚部为零。

其中，特定材质对光的选择性吸收是因为所选择的光波频率与该材质原子中的电子振动的频率相匹配。由于不同的原子和分子具有不同的固有振动频率，其将选择性地吸收不同频率的可见光。光的吸收对视觉效果有直接影响，因为会降低光的强度，并且如果吸收对某些可见波长具有选择性，也会改变光的颜色。

光在表面的折射条件是在小于单一波长的距离内发生折射率的突然变化。另外，折射率缓慢的逐渐变化不会导致光线的分离，而是导致其传播路径的弯曲。当空气密度因温度而变化时，通常可以看到这种效果，例如海市蜃楼 mirages 和热形变 heat distortion。

### 吸收和散射对外观的影响
光与物质之间的两种相互作用模式为**散射 scattering** 和**吸收 absorption**。  
&emsp;&emsp; - **散射 scattering 决定介质的浑浊程度**。 大多数情况下，固体和液体介质中的颗粒都比光的波长更大，并且倾向于均匀地散射所有可见波长的光。高散射会产生不透明的外观。  
&emsp;&emsp; - **吸收 absorption 决定材质的外观颜色**。几乎任何材质的外观颜色通常都是由其吸收的波长相关性引起的。

而每种介质的外观是散射和吸收两种现象的综合结果，如下图：

<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/qifuDWyvb7mHUrI.png" width = "80%" height = "80%" alt="图2 - 具有不同光的吸收量和散射量的介质。外观取决于散射和吸收两个属性; 例如，白色外观（右下）是高散射和低吸收的结果。"/>
</div>

**材质的最终外观由镜面反射 Specular reflection 以及物质对折射光线的吸收和散射的特性组合综合决定。**

另外，散射和吸收都与观察尺度有关。在小场景中不产生任何明显散射的介质在较大尺度上可能具有非常明显的散射。例如，当观察房间中的一杯水时，在空气中的光的散射和在光在水中的吸收都是不可见的。但是，水在数米的距离内对光线进行吸收，特别是对于红色波长对应的光的吸收非常强烈。又例如，在多英里的空气中会有明显的光的散射。

### 几何光学 Geometrical Optics
<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/ru9LeBpv2w6tg4U.webp" width = "80%" height = "80%" alt="图3 - 光与物体表面的交互图示。（来自 GDC 2016，An End-to-End Approach to Physically Based Rendering）"/>
</div>

当一束光线入射到物体表面时，由于物体表面与空气两种介质之间折射率的快速变化，光线会发生反射和折射：  
①**镜面反射 Specular Reflection**：即光线在两种介质交界处的直接反射，金属的镜面反射颜色为三通道的彩色，而非金属的镜面反射颜色为单通道的单色。镜面反射占入射光线的比率由菲涅耳方程计算而得，镜面反射的集中度由微平面的表面粗糙度决定，微平面的表面粗糙度越大（越不规则），反射光线的分散程度越强，反射越模糊；  
②**折射 Refraction**：从表面折射入介质的光，会发生吸收 absorption 和散射 scattering，而介质的整体外观由其散射和吸收特性的组合决定，其中：  
&emsp;&emsp; - **散射 Scattering**：折射率的快速变化引起散射，光的方向会改变（分裂成多个方向），但是光的总量或光谱分布不会改变。散射最终被视作的类型与观察尺度有关，包括：  
&emsp;&emsp;&emsp;&emsp; a. **次表面散射 Subsurface Scattering**：观察像素小于散射距离，散射被视作次表面散射。  
&emsp;&emsp;&emsp;&emsp; b. **漫反射 Diffuse**：观察像素大于散射距离，散射被视作漫反射。  
&emsp;&emsp;&emsp;&emsp; c. **透射 Transmission**：入射光经过折射穿过物体后的出射现象。透射为次表面散射的特例。  
&emsp;&emsp; - **吸收 Absorption**：具有复折射率的物质区域会引起吸收，具体原理是光波频率与该材质原子中的电子振动的频率相匹配。复折射率 complex number 的虚部 imaginary part 确定了光在传播时是否被吸收（转换成其他形式的能量）。发生吸收的介质的光量会随传播的距离而减小（如果吸收优先发生于某些波长，则可能也会改变光的颜色），而光的方向不会因为吸收而改变。任何颜色色调通常都是由吸收的波长相关性引起的。

### 物质的光学特性 Substance Optical Properties
现实世界中有不同类型的物质可分为三大类：**绝缘体 Insulators**，**半导体 semi-conductors** 和**导体 conductors**。在渲染和游戏领域，我们一般只对其中的两个感兴趣：导体（金属）和绝缘体（电介质，非金属）：  
①**金属 Metal**：金属的外观主要取决于光线在两种介质的交界面上的直接反射（即镜面反射）。**金属的镜面反射颜色为三通道的彩色，R、G、B 各不相同。**而折射入金属内部的光线几乎立即全部被自由电子吸收，且折射入金属的光不存在散射。  
②**非金属 No-Metal**：即**绝缘体 Insulators** 或**电介质 Dielectric**，其的整体外观主要由其吸收和散射的特性组合决定。**非金属的镜面反射颜色为单通道单色，即 R = G = B。**光从表面折射入非金属介质，则介质的整体外观由其散射和吸收的特性组合决定。不同的介质类型的散射和吸收特性不一，按介质类型的散射和吸收特性，可以分为多类：  
&emsp;&emsp; - **均匀介质 Homogeneous Media**：主要为透明介质，无折射率变化。不存在散射，光总以直线传播并且不会改变方向。存在吸收，光的强度会通过吸收减少，传播距离越远，吸收量越高。  
&emsp;&emsp; - **非均匀介质 Nonhomogeneous Media**：通常可以建模为具有嵌入散射粒子的均匀介质。具有折射率变化，又分为以下几类：  
&emsp;&emsp;&emsp;&emsp; a. **混浊介质 Cloudy Media**：混浊介质具有弱散射，散射方向略微随机化。根据组成的不同，具有复数折射率的物质区域引起吸收。   
&emsp;&emsp;&emsp;&emsp; b. **半透明介质 Translucent Media**：半透明介质具有强散射，散射方向完全随机化。根据组成的不同，具有复数折射率的物质区域引起吸收。  
&emsp;&emsp;&emsp;&emsp; c. **不透明介质 Opaque Media**：不透明介质和半透明介质一致。具有强散射，散射方向完全随机化。根据组成的不同，具有复数折射率的物质区域引起吸收。 


## 微平面理论 Microfacet Theory  
该理论认为物体表面做无数微观尺度上有随机朝向的理想镜面反射的小平面 microfacet 的理论。在实际的 PBR 工作流中，这种物体表面的不规则性用粗糙度贴图或者高光度贴图来表示。  

光在与**非光学平坦表面 Non-Optically-Flat Surfaces** 的交互时，非光学平坦表面表现得像一个微小的光学平面表面的大集合。表面上的每个点都会以略微不同的方向对入射光反射，而最终的表面外观是许多具有不同表面取向的点的聚合结果。出于着色的目的，通常会用统计方法处理这种微观几何现象，将表面视为具有微观结构法线的随机分布，并将宏观表面视为在每个点处多个方向上反射（和折射）光的集合。在微观尺度上，表面越粗糙，反射越模糊，表面越光滑，反射越集中。

上面说的是微表面的反射，下面讨论被微表面折射的光。从表面折射的光取决于对象本身的特性：  
&emsp;&emsp; - 对于**金属**，折射光会立刻被吸收，能量被自由电子立即吸收。  
&emsp;&emsp; - 对于**非金属**（电介质或绝缘体），一旦光在其内部折射，就表现为常规的参与介质，表现出吸收和散射两种行为。

另外，漫反射和**次表面散射 Subsurface Scattering，SSS** 其实是相同物理现象，本质都是折射光的次表面散射的结果。唯一的区别是相对于观察尺度的散射距离。散射距离相较于像素来说微不足道，次表面散射便可以近似为漫反射。也就是说，光的折射现象，建模为漫反射还是次表面散射，取决于观察的尺度。

## 菲涅尔反射 Fresnel Reflectance
光线以不同角度入射会有不同的反射率。相同的入射角度，不同的物质也会有不同的反射率。万物皆有菲涅尔反射。F0是即 0 度角入射的菲涅尔反射值。大多数非金属的 F0 范围是 0.02 ~ 0.04，大多数金属的 F0 范围是 0.7 ~ 1.0。 

### 菲涅尔效应 Fresnel Effect
菲涅尔效应 Fresnel effect 作为基于物理的渲染理念中的核心理念之一，表示的是看到的光线的反射率与视角相关的现象，其具体表现是在掠射角（与法线呈接近 90 度）下光的反射率会增加。

<div  align="center">  
<img src="https://s2.loli.net/2024/05/22/UOaeGA9cd7ZwhEL.webp" width = "70%" height = "70%" alt="图4 - 菲涅尔效应"/>
</div>

菲涅尔效应即描述视线垂直于表面时反射较弱，而当视线非垂直表面时，夹角越小，反射越明显的一种现象。比如说，当我们站在湖边低头看脚下的湖水，会发现水是透明的，反射不会特别强烈；而如果我们看远处的湖面时，会发现水并不透明，而且反射非常强烈。

需要注意的是，我们在宏观层面看到的菲涅尔效应实际上是微观层面微平面菲涅尔效应的平均值。也就是说，影响菲涅尔效应的关键参数在于每个微平面的法向量和入射光线的角度，而不是宏观平面的法向量和入射光线的角度。当从接近平行于表面的视线方向进行观察，所有光滑表面都会变得 100% 的反射性。对于粗糙表面来说，在接近平行方向的高光反射也会增强，但不够达到 100% 的强度。

不同材质的菲涅尔效应的强弱是不同的，导体（如金属）的菲涅尔效应一般很弱，主要是因为导体本身的反射率就已经很强。就拿铝来说，其反射率在所有角度下几乎都保持 86% 以上，随角度变化很小，而绝缘体材质的菲涅尔效应就很明显，比如折射率为 1.5 的玻璃，在表面法向量方向的反射率仅为 4%，但当视线与表面法向量夹角很大的时候，反射率可以接近 100%，这一现象也导致了金属与非金属外观上的不同。

### 菲涅尔方程 Fresnel Equations
菲涅尔方程是描述光在不同折射率的介质之间的行为的方程。菲涅尔方程描述的光的反射现象便被称之为菲涅尔反射。菲涅尔方程能解释反射光的强度、折射光的强度、相位与入射光的强度的关系。

菲涅尔方程和**麦克斯韦方程组 Maxwell’s equations** 有很深的渊源。根据物理学，麦克斯韦方程组可以在折射率变化时计算光的行为。对于空气中通常的物体表面而言，物体的表面便是空气折射率和物体折射率的交界面，对此特殊的折射率交界面而言，麦克斯韦方程组的解被我们称为菲涅尔方程。即菲涅尔反射的方程可以通过麦克斯韦电磁学方程组推导出来，因为本质上讲菲涅尔反射其实是使用的波动理论来解释光的反射现象。

完整的菲涅尔方程有点复杂，至少可以说艺术家所需的材质参数（在可见光谱上密集采样的复折射率）并不方便。而通过完整的菲涅尔方程，我们可以拟合出更简化的近似表达式（如 Schlick\[1994\] 的 Fresnel 近似），以及抽象出描述物体表面属性的菲涅尔反射率 F0。

<div  align="center">  
<img src="https://s2.loli.net/2024/05/22/RXKuOFW1h5dLg6H.webp" width = "60%" height = "60%" alt="图5 - 各种物质的菲涅尔反射率（y 轴）作为入射角（x 轴）的函数。由于铜和铝在可见光谱上的反射率有明显变化，因此它们的反射率显示为 R，G 和 B 的三条独立曲线。铜的 R 曲线最高，其次是 G，最后是 B（因此它的红色）。铝的 B 曲线最高，其次是 G，最后是 R。上图选择的材质代表了各种各样的材质。尽管如此，可以看到一些共同的地方。对于 0° 和 45° 之间的入射角，反射率几乎是恒定的。在 45° 和 75° 之间，反射率变化更为显着（通常但不总是有所增加）。最后，在 75° 和 90° 之间，反射率总是迅速变为 1。（图片来自 Hoffman N. Background: Physics and Math of Shading）"/>
</div>

当光线垂直（以 0 度角）撞击表面时，该光线被反射 Reflected 为镜面反射光的比率被称为 **F0**。即 F0 为 0 度角入射时的菲涅尔反射率。而折射 refracted 到表面中的光量则为 1 - F0。大多数常见电介质的 F0 范围为 0.02 - 0.05（线性值）。 对于导体，F0 范围为 0.5 - 1.0。

F0 是一个反射系数，可以通过折射率 n 来计算（Schlick’s approximation 中的计算，只适用于对电介质的 F0 的估计）：  

$$ F_0 = (\frac {n_1 - n_2} {n_1 + n_2})^2 $$

其中，n1 和 n2 分别为两种介质的折射率。通常假设 n1 = 1 近似于空气的折射率，并用 n 替换 n2 ，于是，上式可以简化为：  

$$ F_0 = (\frac {n - 1} {n + 1})^2 $$

一个查折射率 IOR 的网站：https://pixelandpoly.com/ior.html 。对于一般仅有实数折射率的非金属而言，可以通过查询到的物质的折射率和上面的公式，计算出 F0。

### 常见材质 F0 特性总结

<div  align="center">  
<img src="https://s2.loli.net/2024/05/22/71tFO6mnv2iz9fW.png" width = "80%" height = "80%" alt="图6 - 常见材质 F0 参考速查图表"/>
</div>

需要注意，我们一般使用的 F0，都是空气对于材质的F0。假如材质位于水中或其他折射率不等于 1 的介质中，F0 会发生变化。

**①金属 Metal**  
&emsp;&emsp; - 金属具有高的 F0 值 - 几乎总是 0.5 或更高。一些金属具有在可见光谱范围内变化的光学性质，导致了这些金属有色的菲涅尔反射率。  
&emsp;&emsp; - 黄金有一个不寻常的 F0 值，是最亮的金属之一。其红色通道值略高于 1，而且具有特别低的蓝色通道值（低于 0.5）。  
&emsp;&emsp; - 金属会立即吸收任何透射光，因此它们不会出现任何次表面散射或透明感。  
&emsp;&emsp; - 金属的所有可见颜色都来自 F0。

**②电介质 Dielectrics**  
&emsp;&emsp; - 日常生活中遇到的大多数材质都是电介质，比如玻璃，皮肤，木头，头发，皮革，塑料，石头和混凝土等等。水其实也是电介质（绝缘体），水的导电性是由于水中的各种杂质造成的。  
&emsp;&emsp; - 电介质具有相当低的 F0 值 - 通常为 0.06 或更低。在垂直入射时的这种低反射率使得菲涅尔效应对于电介质尤其明显。电介质的光学性质在可见光谱上很少变化很大，导致无色反射率值。  
&emsp;&emsp; - 水晶和宝石，其实大多数情况下组成成分是石英 Quartz，而石英的主要化学成分为 SiO2，也是电介质（绝缘体）。石英根据颜色，可以分为：紫水晶、黄水晶、粉晶、烟水晶、乳石英、白水晶等。  

**③半导体 Semiconductor**  
&emsp;&emsp; - 常见的半导体材质有硅、锗、砷化镓等。  
&emsp;&emsp; - 正如半导体电导率位于绝缘体至导体之间一样，其 F0 值也位于最亮的电介质和最暗的金属之间。  


## 其他相关理论
①**能量守恒 Energy Conservation**
出射光线的能量永远不能超过入射光线的能量。随着粗糙度的上升镜面反射区域的面积会增加，作为平衡，镜面反射区域的平均亮度则会下降。  

②**线性空间 Linear Space**
光照计算必须在线性空间完成，shader 中输入的 gamma 空间的贴图比如漫反射贴图需要被转成线性空间，在具体操作时需要根据不同引擎和渲染器的不同做不同的操作。而描述物体表面属性的贴图如粗糙度，高光贴图，金属贴图等必须保证是线性空间。 

③**色调映射 Tone Mapping**  
也称色调复制 tone reproduction，是将宽范围的照明级别拟合到屏幕有限色域内的过程。因为基于 HDR 渲染出来的亮度值会超过显示器能够显示最大亮度，所以需要使用色调映射，将光照结果从 HDR 转换为显示器能够正常显示的 LDR。  

# 渲染方程与 BxDF 简介

# Disney Principled BxDF