---
title: PBR 理论基础（一）
date: 2024-05-21 14:20:48
categories: 
  - [图形学]
tags:
  - 图形学
  - 游戏开发
top_img: /images/black.jpg
cover: https://s2.loli.net/2024/05/21/6QnAbYhwJX4Bavl.png
mathjax: true
description: 本笔记的主要内容有 XXXXXXXXX。
---

> 本篇文章主要参考了毛星云的文章：《基于物理的渲染（PBR）白皮书》。本来有了毛星云的文章不打算自己再另写一篇关于 PBR 理论知识的文章了，但是后来还是决定以自己的语言复述一遍并做出一定的简化，方便自己理解。  
> 
> 之前的《Unity Shader入门精要》读书笔记（五）中也有对 PBR 的介绍，对重复的较熟悉的内容不再详细复述。

# PBR 核心理论基础
**基于物理的渲染 Physically Based Rendering，PBR** 是指使用基于物理原理和微平面理论建模的着色/光照模型，以及使用从现实中测量的表面参数来准确表示真实世界材质的渲染理念。可以由三部分组成基于物理的材质 Material，基于物理的光照 Lighting 以及基于物理适配的摄像机 Camera。

PBR 的理论基础主要包括以下内容： 

## 光学相关
### 人眼视觉  
人眼接收到的是物体反射和散射得到的颜色，那些不能被物体吸收 Absorb 的颜色，即被反射或散射到我们人眼中的可见光波长代表的颜色，就是我们能够感知到的物体的颜色。

被反射或散射的光线进入人眼后，首先穿过**角膜 cornea**， 然后进入**瞳孔 pupil**。 随后，光被**晶状体 lens** 折射并撞击**视网膜 retina** 中的两种类型的**感光细胞 photoreceptors**，包括**视锥细胞 cones** 和**视杆细胞 rods**。这些感光细胞从视野范围内吸收光子，然后经一系列特殊复杂的生物化学通路，根据光线中的不同的波长产生不同颜色的视觉信号，波长越高的光偏红，波长越低的光偏蓝。视觉信号通过视神经 optical nerve 传递到视觉皮层 visual cortex，而视觉皮层作为处理视觉信号的大脑区域，用于产生最终的感知图像。上述负责整体人类视觉功能的完整系统被称为**人类视觉系统 Human Visual System，HVS**。不同感光细胞对不同波长的感知敏感度不同。只有可见光才能被人眼感知并处理，而可见光仅覆盖完整电磁波谱在 400 nm 和 700 nm之间非常有限的光谱区间。

### 物理光学 Physical Optics
**波动光学 Wave Optics** 又称**物理光学 Physical Optics**。在波动光学中，光被建模为一种**电磁横波 Transverse Wave**，即电磁波伴随的电场方向、磁场方向和传播方向三者互相垂直。

<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/8hKv6VDsdZjuGyn.png" width = "60%" height = "60%" alt="图1 - 一个简单的光波。它既是单色的（具有单一波长 λ ）又是线性极化的（电场和磁场各自沿单向振荡）"/>
</div>

光波的磁场和电场的振荡相互耦合，且磁场矢量和电场矢量相互垂直，两者长度之比固定，该比率等于**相速度 Phase Velocity**。

而光在传播到两种不同介质交界处时，原始光波和新的光波的相速度 Phase Velocity 的比率定义了介质的光学性质，就是**折射率 Index of Refraction，IOR**，由字母 n 表示。

### 复折射率 complex index of refraction
除了代表光的相速度的实部 $\,n\,$ 之外，还用希腊字母 $\,\kappa\,$（kappa）表示介质将光能转为为其他形式能量的吸收性。$\,n\,$ 和 $\,\kappa\,$ 通常都随波长而变化，两者组合成复数 $\,n + i\kappa\,$，称为**复折射率 complex index of refraction**。

即折射率 IOR 是一个复数，其分为实部和虚部两部分：  
&emsp;&emsp; - 折射率的**实部 real part** 度量了物质如何影响光速，即相对于光在真空中传播速度减慢的度量。  
&emsp;&emsp; - 折射率的**虚部 imaginary part** 确定了光在传播时是否被吸收，转换成其他形式的能量，通常是热能。非吸收性介质虚部为零。

其中，特定材质对光的选择性吸收是因为所选择的光波频率与该材质原子中的电子振动的频率相匹配。由于不同的原子和分子具有不同的固有振动频率，其将选择性地吸收不同频率的可见光。光的吸收对视觉效果有直接影响，因为会降低光的强度，并且如果吸收对某些可见波长具有选择性，也会改变光的颜色。

光在表面的折射条件是在小于单一波长的距离内发生折射率的突然变化。另外，折射率缓慢的逐渐变化不会导致光线的分离，而是导致其传播路径的弯曲。当空气密度因温度而变化时，通常可以看到这种效果，例如海市蜃楼 mirages 和热形变 heat distortion。

### 吸收和散射对外观的影响
光与物质之间的两种相互作用模式为**散射 scattering** 和**吸收 absorption**。  
&emsp;&emsp; - **散射 scattering 决定介质的浑浊程度**。 大多数情况下，固体和液体介质中的颗粒都比光的波长更大，并且倾向于均匀地散射所有可见波长的光。高散射会产生不透明的外观。  
&emsp;&emsp; - **吸收 absorption 决定材质的外观颜色**。几乎任何材质的外观颜色通常都是由其吸收的波长相关性引起的。

而每种介质的外观是散射和吸收两种现象的综合结果，如下图：

<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/qifuDWyvb7mHUrI.png" width = "80%" height = "80%" alt="图2 - 具有不同光的吸收量和散射量的介质。外观取决于散射和吸收两个属性; 例如，白色外观（右下）是高散射和低吸收的结果。"/>
</div>

**材质的最终外观由镜面反射 Specular reflection 以及物质对折射光线的吸收和散射的特性组合综合决定。**

另外，散射和吸收都与观察尺度有关。在小场景中不产生任何明显散射的介质在较大尺度上可能具有非常明显的散射。例如，当观察房间中的一杯水时，在空气中的光的散射和在光在水中的吸收都是不可见的。但是，水在数米的距离内对光线进行吸收，特别是对于红色波长对应的光的吸收非常强烈。又例如，在多英里的空气中会有明显的光的散射。

### 几何光学 Geometrical Optics
<div  align="center">  
<img src="https://s2.loli.net/2024/05/21/ru9LeBpv2w6tg4U.webp" width = "80%" height = "80%" alt="图3 - 光与物体表面的交互图示。（来自 GDC 2016，An End-to-End Approach to Physically Based Rendering）"/>
</div>

当一束光线入射到物体表面时，由于物体表面与空气两种介质之间折射率的快速变化，光线会发生反射和折射：  
①**镜面反射 Specular Reflection**：即光线在两种介质交界处的直接反射，金属的镜面反射颜色为三通道的彩色，而非金属的镜面反射颜色为单通道的单色；  
②**折射 Refraction**：


## 微平面理论 Microfacet Theory  
该理论认为物体表面做无数微观尺度上有随机朝向的理想镜面反射的小平面 microfacet 的理论。在实际的 PBR 工作流中，这种物体表面的不规则性用粗糙度贴图或者高光度贴图来表示。  

光在与**非光学平坦表面 Non-Optically-Flat Surfaces** 的交互时，非光学平坦表面表现得像一个微小的光学平面表面的大集合。表面上的每个点都会以略微不同的方向对入射光反射，而最终的表面外观是许多具有不同表面取向的点的聚合结果。出于着色的目的，通常会用统计方法处理这种微观几何现象，将表面视为具有微观结构法线的随机分布，并将宏观表面视为在每个点处多个方向上反射（和折射）光的集合。在微观尺度上，表面越粗糙，反射越模糊，表面越光滑，反射越集中。

上面说的是微表面的反射，下面讨论被微表面折射的光。从表面折射的光取决于对象本身的特性：  
&emsp;&emsp; - 对于**金属**，折射光会立刻被吸收，能量被自由电子立即吸收。  
&emsp;&emsp; - 对于**非金属**（电介质或绝缘体），一旦光在其内部折射，就表现为常规的参与介质，表现出吸收和散射两种行为。

另外，漫反射和**次表面散射 Subsurface Scattering，SSS** 其实是相同物理现象，本质都是折射光的次表面散射的结果。唯一的区别是相对于观察尺度的散射距离。散射距离相较于像素来说微不足道，次表面散射便可以近似为漫反射。也就是说，光的折射现象，建模为漫反射还是次表面散射，取决于观察的尺度。

②**能量守恒 Energy Conservation**  
出射光线的能量永远不能超过入射光线的能量。随着粗糙度的上升镜面反射区域的面积会增加，作为平衡，镜面反射区域的平均亮度则会下降。  

③**菲涅尔反射 Fresnel Reflectance**：光线以不同角度入射会有不同的反射率。相同的入射角度，不同的物质也会有不同的反射率。万物皆有菲涅尔反射。F0是即 0 度角入射的菲涅尔反射值。大多数非金属的 F0 范围是 0.02 ~ 0.04，大多数金属的 F0 范围是 0.7 ~ 1.0。  
④**线性空间 Linear Space**：光照计算必须在线性空间完成，shader 中输入的 gamma 空间的贴图比如漫反射贴图需要被转成线性空间，在具体操作时需要根据不同引擎和渲染器的不同做不同的操作。而描述物体表面属性的贴图如粗糙度，高光贴图，金属贴图等必须保证是线性空间。  
⑤**色调映射 Tone Mapping**，也称色调复制 tone reproduction，是将宽范围的照明级别拟合到屏幕有限色域内的过程。因为基于 HDR 渲染出来的亮度值会超过显示器能够显示最大亮度，所以需要使用色调映射，将光照结果从 HDR 转换为显示器能够正常显示的 LDR。  
⑥**物质的光学特性 Substance Optical Properties**：现实世界中有不同类型的物质可分为三大类：**绝缘体 Insulators**，**半导体 semi-conductors** 和**导体 conductors**。在渲染和游戏领域，我们一般只对其中的两个感兴趣：导体（金属）和绝缘体（电解质，非金属）。其中非金属具有单色/灰色镜面反射颜色，而金属具有彩色的镜面反射颜色。即非金属的 F0 是一个 float。而金属的 F0 是一个 float3。

