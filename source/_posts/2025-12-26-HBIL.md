---
title: Horizon-Based Indirect Lighting (HBIL)
date: 2025-12-26 15:44:00
categories: 
  - [图形学]
  - [unity, pipeline]
tags:
  - 图形学
  - 游戏开发
  - unity
top_img: /images/black.jpg
cover: https://s2.loli.net/2025/12/26/YpyBQSsUquzxeLP.gif
mathjax: true
description: 本文章主要内容有XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX。
---

> 这里再次强调一下，屏幕空间全局光照技术，诸如 SSDO、HBIL、SSGI 等，最好是作为低频全局光照技术的高频补充，从而做到双方优势互补，单独使用屏幕空间全局光照的结果只能说是差强人意。我大致实现了一下使用上一帧场景颜色 (Radiance) 从而实现无限弹射的 SSDO，在配合 APV (Fallback APV) 使用时，确实能做到较好地补充**近距离 Near Field** 的高频细节，但单独使用，就只能提供一定范围内的间接光照，毕竟受到采样半径的限制。因为 Horizon Based 的算法的物理正确性肯定要比基于 SSAO 的 SSDO 要高很多，所以 SSDO 算法我就不在 YPipeline 里支持了，打算好好实现 HBIL。至于 SSGI，因为其是通过步进的方式采样深度贴图进行求交，有点浪费采样次数，所以我觉得效果应该是不如 HBIL 的，噪点应该比 HBIL 多，我打算之后有空了再实现。  

**Horizon-Based Indirect Lighting (HBIL)** 简单来说是一个受到 HBAO 技术启发的屏幕空间全局光照技术，通过补充 near-field 光照显著增加了实时渲染质量。该算法出自这篇文章：Benoît Mayaux. 2018. Horizon Based Indirect Lighting (HBIL): https://github.com/Patapom/GodComplex/tree/master/Tests/TestHBIL ，下面的内容都是基于这篇文章书写的。之前在 [SSAO 的文章](https://ybniaobu.github.io/2025/08/01/2025-08-01-SSAO1/) 开头提到的这个库 https://github.com/cdrinmatane/SSRT3 的实现，本质上也是基于 HBIL 的。

# HBIL 基本原理
首先说明，文章中使用的球坐标是右手坐标系，且天顶角 $\,\theta\,$ 是基于 z 轴的，方位角 $\,\varphi\,$ 则是在 xy 平面基于 x 轴的角度。根据经典反射方程，在像素点 $\,x\,$ 的出射 radiance 为：  

$$ \begin{equation*} L_o(x, \omega_o) = \int_{\Omega^+}L_i(x,\omega_i)\rho(x, \omega_i, \omega_o)(n \cdot \omega_i) d\omega_i \end{equation*} $$

因为处理的是漫反射全局光照，可以将 Lambertian 项拆分出来：  

$$ \begin{equation*} L_o(x, \omega_o) = \cfrac {\rho(x)}{\pi} \int_{\Omega^+}L_i(x,\omega_i)(n \cdot \omega_i) d\omega_i = \cfrac {\rho(x)}{\pi} E(x, n) \end{equation*} $$

其中 $\,E(x, n)\,$ 是在像素点 $\,x\,$ 收集到的 irradiance。同时它又可以被分为 3 个部分：  

$$ E(x, n) = E_{direct}(x, n) + E_{far}(x, n) + E_{near}(x, n) $$

<div align="center">  
<img src="https://s2.loli.net/2025/12/29/QkLxHCtjvAWhMRS.png" width = "40%" height = "40%" alt="图1 - The 3 possible sources of irradiance: Direct Lighting, Far-Field Lighting, Near-Field Lighting"/>
</div>

直接光部分没什么好说的，HBIL 的本质就是补充 near-field 的间接光，而 far-field 后面会专门提到，往往通过采样 Cube Map 或球谐获取。$\, E_{near}(x, n) \,$ 可以被写为：  

$$ E_{near}(x, n) = \int_{\Omega^+} (1 - V(x, \omega_i)) L_i(x,\omega_i) (n \cdot \omega_i) d\omega_i $$

注意这里的可见性函数 $\,V(x, \omega_i)\,$ 是被遮挡返回 0，未遮挡返回 1。而 $\, E_{far}(x, n) \,$ 可以被写为：  

$$ E_{far}(x, n) = \int_{\Omega^+} V(x, \omega_i) L_i(x,\omega_i) (n \cdot \omega_i) d\omega_i $$

可以看到，near-field 项正好是 far-field 项的补充。

## 递归无限反射
当渲染第 N 帧画面时，我们就已经得到了第 N - 1 帧的 radiance 值，此时我们可以将反射方程改写为：  

$$ L_o^N(x, \omega_o) = \cfrac {\rho(x)}{\pi} \left[ E_{direct}^N(x, n) + E_{far}^N(x, n) + \int_{\Omega^+} L_d^{N - 1}(x') (n \cdot \omega_i) d\omega_i \right] $$

其中 $\,L_o^N(x, \omega_o)\,$ 就是第 N 帧的 radiance，会在第 N + 1 帧被再次作为输入值。$\,L_d^{N - 1}(x')\,$ 是在周围像素点 $\,x'\,$ 的第 N - 1 帧的 radiance 值。这样子计算 radiance 从理论上来说让我们得到一个无限光线弹射的效果。

## Near-Field 间接光
### 积分求解
跟 GTAO 一样，我们先来关注内积分，即每个 slice，将 slice 画出来如下图（其实这张图，我觉得是画错了的，因为文章开头就说 $\,\theta\,$ 是基于 z 轴的角度，而这里不是。虽然画错了，但不影响我们解积分）：  

<div align="center">  
<img src="https://s2.loli.net/2025/12/29/eMBWplcVR8mKw2q.png" width = "40%" height = "40%" alt="图2 - Sampling the gathered irradiance when the horizon is rising from θ0 到 θ1."/>
</div>

其中 $\,\theta_0\,$ 到 $\,\theta_1\,$ 部分的积分可以写为（由于上图画错，我们需将 $\,\theta\,$ 看作是基于 z 轴的角度，假设 $\,\theta_1\,$ 的这条虚线是 $\,\theta_0\,$， $\,\theta_0\,$ 的这条虚线是 $\,\theta_1\,$，*一定要注意顺序问题*，我们后面代码中步进得到的更小的角，即 cos 值更大的，应该写入 $\,\theta_0\,$）：  

$$ \Delta E = \int_{\theta_0}^{\theta_1} L_d(x') (n' \cdot w_i') sin \theta d\theta $$

其中 $\,n'\,$ 是投影到 slice 平面的法线，这点 GTAO 中也有提到过。文章中积分求解的方法跟 GTAO 有较大不同，其中 $\,n' \cdot w_i'\,$ 的化简是在 Slice 这个 2D 空间中化简的，如下图：  

<div align="center">  
<img src="https://s2.loli.net/2026/01/05/4QVsOIGijmhS3zk.png" width = "30%" height = "30%" alt="图3 - Slice Space"/>
</div>

每个 slice 的切线方向 $\,\widehat D(\varphi)\,$ 就是我们随机出来的方向（将半球切分）。对于 slice space 这个 2D 空间来说，$\,\widehat D(\varphi)\,$ 可以被定义为 $\,(1, 0)\,$，视角方向 $\,\widehat \omega_o\,$ 可以被定义为 $\,(0, 1)\,$，采样点 $\,x'\,$ 则是 slice space 原点。那么此时法线 $\,n\,$ 在 slice 的投影 $\,n'\,$ 的 slice space 坐标可以写为：  

$$ n' = \begin{cases} \widehat n \cdot \widehat D(\varphi) \\ \widehat n \cdot \widehat \omega_o \end{cases} = \begin{cases} n_x \\ n_y \end{cases} $$

其中 $\,\widehat n\,$、$\,\widehat D(\varphi)\,$、$\,\widehat \omega_o\,$ 都是世界空间（或相机空间）下的坐标，点乘计算出 cos 值，即是法线投影在 slice 上的 $\,n'\,$ 的 slice space 坐标，写作 $\,(n_x, n_y)\,$。与此同时，$\,w_i'\,$ 的 slice space 坐标可以写为 $\,\left(sin\theta, cos\theta\right)\,$，于是 $\,\Delta E\,$ 积分可以化简为：  

$$ \Delta E = L_d(x') \int_{\theta_0}^{\theta_1} (n_xsin \theta + n_ycos \theta)sin\theta d\theta $$

又因为 $\,sin^2 \theta\,$、$\,sin \theta cos \theta\,$ 的积分分别为：  

$$ \int sin^2 \theta d\theta = \cfrac {1}{2}\theta - \cfrac {1}{2} sin \theta cos \theta + C $$
$$ \int sin \theta cos \theta d\theta = \cfrac {1}{2} sin^2 \theta + C = -\cfrac {1}{2} cos^2 \theta + C $$

最终 $\,\Delta E\,$ 为：  

$$ \Delta E = L_d(x') [\cfrac {n_x} {2}(\theta_1 - \theta_0 + sin\theta_0 cos\theta_0 - sin\theta_1 cos\theta_1) + \cfrac {n_y} {2}(sin^2 \theta_1 - sin^2 \theta_0)] $$

### 计算 Horizon Angle
之前 GTAO 的 Horizon Angle 计算的想法是比较简单的，就是将步进的采样点减去中心采样点，得到的向量 h 和视角方向 v 点乘得到 cos 值，再反三角函数。因为向量 h 和视角方向 v 需要在同一空间下做点乘，所以需要一些矩阵运算，而 HBIL 文章中的方法进一步进行了简化，可以减少矩阵运算：  

<div align="center">  
<img src="https://s2.loli.net/2026/01/05/nUM5xcgrjIyz963.png" width = "25%" height = "25%" alt="图4 - Computing Horizon Angles"/>
</div>

上图中，$\,\widehat Z\,$ 和 $\,\widehat X\,$ 是相机空间（文章中叫做全局相机空间 Global Camera Space）的两个轴，$\,\widehat Z\,$ 指向屏幕内部，$\,\widehat x\,$ 就是中心采样点（步进的出发点），$\,\widehat x_1\,$ 为沿着 slice 步进的新的采样点，步进距离为 $\,r\,$，而 $\,z\,$ 就是采样得到的深度值。我们要计算的 Horizon Angle 是 $\,\theta\,$，这里要注意视角方向 $\,\widehat \omega_o\,$ 和相机空间的 $\,\widehat Z\,$ 轴只有当 $\,\widehat x\,$ 在屏幕中心时才是平行的（$\,\widehat \omega_o\,$ 和 $\,\widehat \omega_x\,$ 所在的空间，文章中称为局部相机空间 Local Camera Space）。我们可以观察到 $\,\theta = \beta - \alpha\,$，于是：  

$$ cos(\theta) = cos(\beta - \alpha) = cos(\alpha) cos(\beta) + sin(\alpha) sin(\beta) $$

同时：  

$$ cos(\beta) = \cfrac {z} {\sqrt{r^2 + z^2}} $$
$$ sin(\beta) = \cfrac {r} {\sqrt{r^2 + z^2}} $$

最终 Horizon Angle 公式为：  

$$ cos(\theta) = \cfrac {cos(\alpha)z + sin(\alpha)r} {\sqrt{r^2 + z^2}} $$

### Normal 钳制
之前 GTAO 就提到过计算出来的 Horizon Angle 有可能不在基于 normal 的半球之内，需要进行钳制，GTAO 的方法是计算出法线与视角方向的角度 n，然后将 Horizon Angle 与 n 的差值钳制在 $\,\pi/2\,$ 以内。HBIL 文章中的方法我感觉更巧妙一点：  

<div align="center">  
<img src="https://s2.loli.net/2026/01/05/W7OCh1fHToYm5Ab.png" width = "40%" height = "40%" alt="图5 - Computing Horizon Angles"/>
</div>

图中 $\,t\,$ 是平行于 $\,\widehat \omega_o\,$ 的一个距离，那么：  

$$ cos \theta_{front} = \cfrac {t} {\sqrt{1 + t^2}} $$
$$ cos \theta_{back} = -\cfrac {t} {\sqrt{1 + t^2}} $$

而 $\,t\,$ 的计算的逻辑如下：  

$$ \widehat n \cdot (\widehat D(\varphi) + t \widehat \omega_o) = 0 \Rightarrow t = - \cfrac {\widehat n \cdot \widehat D(\varphi)}{\widehat n \cdot \omega_o} $$

由此可以计算出 Horizon Angle 的两个初始值。

## Far-Field 间接光
### 积分求解
上面写到过 far-field 的 irradiance 计算公式如下：  

$$ E_{far}(x, n) = \int_{\Omega^+} V(x, \omega_i) L_i(x,\omega_i) (n \cdot \omega_i) d\omega_i $$

这个公式非常眼熟，跟[讲 SSAO 的文章](https://ybniaobu.github.io/2025/08/01/2025-08-01-SSAO1/)中的介绍 Ambient Occlusion 在着色中的运用的公式是一模一样的，由此可以把它简化为：  

$$ E_{far}(x, n) = E_o(x, n) AO(x) $$

其中 $\,E_o(x, n)\,$ 是未被遮挡的 irradiance，可以从 cube map 或者 SH 采样获取。那么 AO 的计算，其实跟 Near-Field 的逻辑是几乎一样的，如下：  

<div align="center">  
<img src="https://s2.loli.net/2026/01/05/o53M7IFDG9rSRqs.png" width = "35%" height = "35%" alt="图6 - AO integral illustration"/>
</div>

注意一下上图的 $\,\theta_0\,$、$\,\theta_1\,$，别跟 Near-Field 的积分的这两个角度搞混了，这里的 $\,\theta_0\,$ 是在 $\,[-\pi, 0]\,$ 之间，$\,\theta_1\,$ 在 $\,[0, \pi]\,$ 之间。根据上图，$\,AO(x)\,$ 可以写为：  

$$ AO(x) \approx \cfrac {1}{N} \sum^S \int_{\theta_0}^{\theta_1} (n \cdot \omega_i(\theta)) |sin \theta| d\theta $$

跟 Near-Field 积分的处理类似，内积分可以写为：  

$$ AO_i = \int_{\theta_0}^{\theta_1} (n' \cdot \omega'_i(\theta)) |sin \theta| d\theta $$

$\,n' \cdot w_i'\,$ 的化简还是在 slice space 这个 2D 空间中进行。只是这里需要将积分拆分为两个部分（跟 GTAO 一样）：  

$$ AO_i = \int_{\theta_0}^{0} (n' \cdot \omega'_i(\theta)) (-sin \theta) d\theta + \int_{0}^{\theta_1} (n' \cdot \omega'_i(\theta)) sin \theta d\theta $$

于是内积分最终为：  

$$ AO_i = \cfrac {n_x} {2}(\theta_1 - \theta_0 + sin\theta_0 cos\theta_0 - sin\theta_1 cos\theta_1) + \cfrac {n_y} {2}(sin^2 \theta_1 + sin^2 \theta_0) $$

再次强调上述公式中的 $\,\theta_0\,$ 是负数，别搞错了！！！！！！！！！！！！

> HBIL 文章中还提到了 $\, E_{far}(x, n) = E_o(x, n) AO(x) \,$ 这样的简化处理，会导致能量上的损失，可以通过计算 bent cone 的立体角来弥补这部分能量损失。我觉得这么做的必要性不大，所以我后面就不打算这么处理了。这里就记录一下公式，bent cone 的 aperture angle $\,\alpha\,$ 的计算在之前 GTAO 文章的 GTSO 章节有提到过，对于 Uniform Weighting：  
>   
> $$ \alpha = cos^{-1} (1 - AO(x)) $$
> 
> 对于 Cosine Weighting： 
> 
> $$ \alpha = cos^{-1} (\sqrt{1 - AO(x)}) $$
> 
> $\, E_{far}(x, n) \,$ 可以通过应用一个因子 $\,\mathcal{F}_0(\alpha)\,$ 来弥补能量损失：  
> 
> $$ E_{far}(x, n) = E_o(x, n) \mathcal{F}_0(AO(x)) $$
> $$ \mathcal{F}_0(\alpha) = \alpha \cdot \left( 1 + \cfrac {(1 - \alpha)^{0.75}}{2} \right) = \alpha \cdot \left( 1 + \cfrac {1 - \alpha} {2 \sqrt[4] {1 - \alpha}} \right)$$
>   
> 上述公式具体怎么来的，详见 HBIL 文章作者的另外一篇文章 [Improved Ambient Occlusion](https://drive.google.com/file/d/1SyagcEVplIm2KkRD3WQYSO9O0Iyi1hfy/edit) 。

### Bent Normal
HBIL 文章还提到了 far-field irradiance 可以通过 Bent Normal 采样以获取更好的效果，Bent Normal 跟上面 AO 的计算一样，是 Near-Field 积分计算过程中的一个副产品。还是根据图 6，Bent Normal $\,\widetilde{n}\,$ 可以写为：  

$$ \widetilde{n} \approx \cfrac {\pi}{N} \sum^N \int_{\theta_0}^{\theta_1} \omega_i(\theta) |sin \theta| d \theta $$

公式中的 $\,\pi\,$ 影响的是向量长度，不用关心。还是老样子，在 slice space 2D 空间中处理，那么：  

$$ \omega_i'(\theta) = \begin{cases} sin\theta \\ cos\theta \end{cases} $$

x、y 分量分开处理，$\,\widetilde{n}\,$ 在 slice space 2D 空间中的坐标可以写为：  

$$ \widetilde{n} = \begin{cases} \widetilde{n}_x \\ \widetilde{n}_y \end{cases} $$
$$ \widetilde{n}_x = \cfrac {1} {2}(\theta_1 - \theta_0 + sin\theta_0 cos\theta_0 - sin\theta_1 cos\theta_1) $$
$$ \widetilde{n}_y = \cfrac {1} {2}(sin^2 \theta_1 + sin^2 \theta_0) $$

再再次提醒，公式中的 $\,\theta_0\,$ 是负数，别搞错了！！！！！！！！！！！！然后我们需要其转换到世界空间：  

