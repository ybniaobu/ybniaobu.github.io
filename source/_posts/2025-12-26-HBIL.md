---
title: Horizon-Based Indirect Lighting (HBIL)
date: 2025-12-26 15:44:00
categories: 
  - [图形学]
  - [unity, pipeline]
tags:
  - 图形学
  - 游戏开发
  - unity
top_img: /images/black.jpg
cover: https://s2.loli.net/2025/12/26/YpyBQSsUquzxeLP.gif
mathjax: true
description: 本文章主要内容有XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX。
---

> 这里再次强调一下，屏幕空间全局光照技术，诸如 SSDO、HBIL、SSGI 等，最好是作为低频全局光照技术的高频补充，从而做到双方优势互补，单独使用屏幕空间全局光照的结果只能说是差强人意。我大致实现了一下使用上一帧场景颜色 (Radiance) 从而实现无限弹射的 SSDO，在配合 APV (Fallback APV) 使用时，确实能做到较好地补充**近距离 Near Field** 的高频细节，但单独使用，就只能提供一定范围内的间接光照，毕竟受到采样半径的限制。因为 Horizon Based 的算法的物理正确性肯定要比基于 SSAO 的 SSDO 要高很多，所以 SSDO 算法我就不在 YPipeline 里支持了，打算好好实现 HBIL。至于 SSGI，因为其是通过步进的方式采样深度贴图进行求交，有点浪费采样次数，所以我觉得效果应该是不如 HBIL 的，噪点应该比 HBIL 多，我打算之后有空了再实现。  

**Horizon-Based Indirect Lighting (HBIL)** 简单来说是一个受到 HBAO 技术启发的屏幕空间全局光照技术，通过补充 near-field 光照显著增加了实时渲染质量。该算法出自这篇文章：Benoît Mayaux. 2018. Horizon Based Indirect Lighting (HBIL): https://github.com/Patapom/GodComplex/tree/master/Tests/TestHBIL ，下面的内容都是基于这篇文章书写的。

# HBIL 基本原理
首先说明，文章中使用的球坐标是右手坐标系，且天顶角 $\,\theta\,$ 是基于 z 轴的，方位角 $\,\varphi\,$ 则是在 xy 平面基于 x 轴的角度。根据经典反射方程，在像素点 $\,x\,$ 的出射 radiance 为：  

$$ \begin{equation*} L_o(x, \omega_o) = \int_{\Omega^+}L_i(x,\omega_i)\rho(x, \omega_i, \omega_o)(n \cdot \omega_i) d\omega_i \end{equation*} $$

因为处理是漫反射全局光照，可以将 Lambertian 项拆分出来：  

$$ \begin{equation*} L_o(x, \omega_o) = \cfrac {\rho(x)}{\pi} \int_{\Omega^+}L_i(x,\omega_i)(n \cdot \omega_i) d\omega_i = \cfrac {\rho(x)}{\pi} E(x, n) \end{equation*} $$

其中 $\,E(x, n)\,$ 是在像素点 $\,x\,$ 收集到的 irradiance。同时它又可以被分为 3 个部分：  

$$ E(x, n) = E_{direct}(x, n) + E_{far}(x, n) + E_{near}(x, n) $$

<div align="center">  
<img src="https://s2.loli.net/2025/12/29/QkLxHCtjvAWhMRS.png" width = "40%" height = "40%" alt="图1 - The 3 possible sources of irradiance: Direct Lighting, Far-Field Lighting, Near-Field Lighting"/>
</div>

直接光部分没什么好说的，HBIL 的本质就是补充 near-field 的间接光，而 far-field 后面会专门提到，往往通过采样 Cube Map 或球谐获取。$\, E_{near}(x, n) \,$ 可以被写为：  

$$ E_{near}(x, n) = \int_{\Omega^+} (1 - V(x, \omega_i)) L_i(x,\omega_i) (n \cdot \omega_i) d\omega_i $$

注意这里的可见性函数 $\,V(x, \omega_i)\,$ 是被遮挡返回 0，未遮挡返回 1。而 $\, E_{far}(x, n) \,$ 可以被写为：  

$$ E_{far}(x, n) = \int_{\Omega^+} V(x, \omega_i) L_i(x,\omega_i) (n \cdot \omega_i) d\omega_i $$

可以看到，near-field 项正好是 far-field 项的补充。

## 递归无限反射
当渲染第 N 帧画面时，我们就已经得到了第 N - 1 帧的 radiance 值，此时我们可以将反射方程改写为：  

$$ L_o^N(x, \omega_o) = \cfrac {\rho(x)}{\pi} \left[ E_{direct}^N(x, n) + E_{far}^N(x, n) + \int_{\Omega^+} L_d^{N - 1}(x') (n \cdot \omega_i) d\omega_i \right] $$

其中 $\,L_o^N(x, \omega_o)\,$ 就是第 N 帧的 radiance，会在第 N + 1 帧被再次作为输入值。$\,L_d^{N - 1}(x')\,$ 是在周围像素点 $\,x'\,$ 的第 N - 1 帧的 radiance 值。这样子计算 radiance 从理论上来说让我们得到一个无限光线弹射的效果。

## 积分求解
跟 GTAO 一样，我们先来关注内积分，即每个 slice，将 slice 画出来如下图（其实这张图，我觉得是画错了的，因为文章开头就说 $\,\theta\,$ 是基于 z 轴的角度，而这里不是。虽然画错了，但不影响我们解积分）：  

<div align="center">  
<img src="https://s2.loli.net/2025/12/29/eMBWplcVR8mKw2q.png" width = "45%" height = "45%" alt="图2 - Sampling the gathered irradiance when the horizon is rising from θ0 到 θ1."/>
</div>

其中 $\,\theta_0\,$ 到 $\,\theta_1\,$ 部分的积分可以写为（由于上图画错，我们需将 $\,\theta\,$ 看作是基于 z 轴的角度，假设 $\,\theta_1\,$ 的这条虚线是 $\,\theta_0\,$， $\,\theta_0\,$ 的这条虚线是 $\,\theta_1\,$，*一定要注意顺序问题*，我们后面代码中步进得到的更小的角，即 cos 值更大的，应该写入 $\,\theta_0\,$）：  

$$ \Delta E = \int_{\theta_0}^{\theta_1} L_d(x') (n' \cdot w_i') sin \theta d\theta $$

其中 $\,n'\,$ 是投影到 slice 平面的法线，这点 GTAO 中也有提到过。但是与 GTAO 不同的是，